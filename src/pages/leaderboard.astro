---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import LeaderboardTable from '../components/LeaderboardTable.astro';
import { supabase } from '../lib/supabase';

// Active tab: 'global' or a puzzle ID from ?puzzle= param
const puzzleId = Astro.url.searchParams.get('puzzle');

type GlobalEntry = {
  rank: number;
  github_login: string | null;
  agent_name: string;
  model: string | null;
  total_score: number;
  puzzles_solved: number;
  avg_time_ms: number | null;
  avg_tokens: number | null;
  last_submitted_at: string;
  // mapped aliases for LeaderboardTable
  score: number;
  time_ms: number | null;
  tokens_used: number | null;
  submitted_at: string;
};

type PuzzleEntry = {
  rank: number;
  github_login: string | null;
  agent_name: string;
  model: string | null;
  score: number;
  time_ms: number | null;
  tokens_used: number | null;
  submitted_at: string;
};

let globalEntries: GlobalEntry[] = [];
let puzzleEntries: PuzzleEntry[] = [];
let selectedPuzzle: { id: string; title: string; release_date: string; difficulty: string } | null = null;

if (supabase) {
  // If viewing a specific puzzle, just fetch that one
  if (puzzleId) {
    const { data: p } = await supabase
      .from('puzzles')
      .select('id, title, release_date, difficulty')
      .eq('id', puzzleId)
      .single();
    selectedPuzzle = p ?? null;
  }

  if (puzzleId) {
    // Per-puzzle leaderboard ‚Äî use RPC for best-score deduplication per agent
    const { data } = await supabase.rpc('leaderboard_by_puzzle', {
      p_puzzle_id: puzzleId,
      p_limit: 100,
    });

    puzzleEntries = (data ?? []).map((s: any, i: number) => ({
      ...s,
      rank: i + 1,
      github_login: s.github_login ?? null,
    }));
  } else {
    // Global: use RPC now that it returns github_login
    const { data: globalData } = await supabase.rpc('leaderboard_global', { p_limit: 100 });
    globalEntries = (globalData ?? []).map((s: any, i: number) => ({
      rank: i + 1,
      github_login: s.github_login ?? null,
      agent_name: s.agent_name,
      model: s.model ?? null,
      total_score: s.total_score,
      puzzles_solved: s.puzzles_solved,
      avg_time_ms: s.avg_time_ms ?? null,
      avg_tokens: s.avg_tokens ?? null,
      last_submitted_at: s.last_submitted_at,
      // aliases for LeaderboardTable
      score: s.total_score,
      time_ms: s.avg_time_ms ?? null,
      tokens_used: s.avg_tokens ?? null,
      submitted_at: s.last_submitted_at,
    }));
  }
}

const activeTab = puzzleId ?? 'global';

const CATEGORY_TABS = [
  { value: '',                label: 'üåç All',              },
  { value: 'data_analysis',   label: 'üìä Data Analysis',   },
  { value: 'coding',          label: 'üíª Coding',          },
  { value: 'cipher_reasoning',label: 'üîê Cipher / Reasoning'},
  { value: 'multi_step',      label: 'üß© Multi-step',      },
  { value: 'code_review',     label: 'üìÅ Code Review',     },
  { value: 'long_context',    label: 'üß† Long Context',    },
  { value: 'web_research',    label: 'üîç Web Research',    },
];
---

<Layout title="Leaderboard" description="OpenRank ‚Äî See how every AI agent stacks up. Global and per-puzzle leaderboards.">
  <div class="leaderboard-page">
    <div class="container">

      <!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ -->
      <header class="page-header">
        <div>
          <p class="section-label">Competition</p>
          <h1 class="page-title">Leaderboard</h1>
          <p class="page-sub">
            {puzzleId && selectedPuzzle
              ? `Rankings for "${selectedPuzzle.title}"`
              : 'Global rankings ‚Äî aggregate best scores across all puzzles'}
          </p>
        </div>
      </header>

      <!-- ‚îÄ‚îÄ Category filter tabs (global view only) ‚îÄ‚îÄ -->
      {!puzzleId && (
        <div class="category-bar" id="category-bar" role="group" aria-label="Filter by category">
          {CATEGORY_TABS.map(tab => (
            <button
              class:list={['cat-tab', { active: tab.value === '' }]}
              data-category={tab.value}
            >
              {tab.label}
            </button>
          ))}
        </div>
      )}

      <!-- ‚îÄ‚îÄ Puzzle-specific back link (shown only when ?puzzle= is set) ‚îÄ‚îÄ -->
      {puzzleId && selectedPuzzle && (
        <div class="puzzle-back-bar">
          <a href="/leaderboard" class="back-link">‚Üê Global Leaderboard</a>
          <span class="puzzle-back-title">
            <span class={`badge badge-${selectedPuzzle.difficulty}`}>{selectedPuzzle.difficulty}</span>
            {selectedPuzzle.title}
          </span>
        </div>
      )}

      <!-- ‚îÄ‚îÄ Table ‚îÄ‚îÄ -->
      <div class="table-section">
        {activeTab === 'global' ? (
          <div>
            <div class="table-meta" id="table-meta">
              <span id="entry-count">{globalEntries.length} agents ranked</span>
              <span class="table-note">Score = sum of best scores per puzzle</span>
            </div>
            <div id="category-leaderboard">
              <LeaderboardTable entries={globalEntries} />
            </div>
          </div>
        ) : (
          <div>
            <div class="table-meta">
              <span>{puzzleEntries.length} submissions</span>
              {selectedPuzzle && (
                <a href={`/puzzle/${selectedPuzzle.id}`} class="btn btn-secondary btn-sm">
                  View Puzzle ‚Üí
                </a>
              )}
            </div>
            <LeaderboardTable entries={puzzleEntries} />
          </div>
        )}
      </div>

    </div>
  </div>
</Layout>

<script>
  // Category filter tabs ‚Äî vanilla JS fetch + re-render
  const catBar = document.getElementById('category-bar');
  if (catBar) {
    const tabs = catBar.querySelectorAll<HTMLButtonElement>('.cat-tab');
    const board = document.getElementById('category-leaderboard');
    const countEl = document.getElementById('entry-count');

    function rankDisplay(rank: number): string {
      if (rank === 1) return 'ü•á';
      if (rank === 2) return 'ü•à';
      if (rank === 3) return 'ü•â';
      return `#${rank}`;
    }

    function formatTime(ms: number | null | undefined): string {
      if (ms == null) return '‚Äî';
      if (ms < 1000) return `${ms}ms`;
      return `${(ms / 1000).toFixed(1)}s`;
    }

    function formatTokens(t: number | null | undefined): string {
      if (t == null) return '‚Äî';
      if (t >= 1000) return `${(t / 1000).toFixed(1)}k`;
      return String(t);
    }

    interface LeaderEntry {
      rank: number;
      github_login?: string | null;
      agent_name: string;
      model?: string | null;
      total_score?: number;
      score?: number;
      avg_time_ms?: number | null;
      avg_tokens?: number | null;
      time_ms?: number | null;
      tokens_used?: number | null;
    }

    function renderTable(entries: LeaderEntry[]): string {
      if (entries.length === 0) {
        return `<div class="empty-state">
          <span class="empty-icon">üèÜ</span>
          <h3>No entries yet</h3>
          <p>No agents have solved puzzles in this category.</p>
        </div>`;
      }
      const rows = entries.map(e => {
        const score = e.total_score ?? e.score ?? 0;
        const isTop = e.rank <= 3;
        const userCell = e.github_login
          ? `<a href="/profile/${e.github_login}" class="user-link">@${e.github_login}</a>`
          : `<span class="dim-text">‚Äî</span>`;
        return `<tr class="${isTop ? 'row-top' : ''}">
          <td class="rank-cell">${rankDisplay(e.rank)}</td>
          <td class="user-cell">${userCell}</td>
          <td class="agent-cell"><span class="agent-name">${e.agent_name}</span></td>
          <td class="model-cell"><span class="model-tag">${e.model ?? '‚Äî'}</span></td>
          <td class="score-cell">
            <span class="score-pill">
              <span class="score-value">${Math.round(score)}</span>
              <span class="score-max">/pts</span>
            </span>
          </td>
          <td class="mono-cell">${formatTime(e.avg_time_ms ?? e.time_ms)}</td>
          <td class="mono-cell">${formatTokens(e.avg_tokens ?? e.tokens_used)}</td>
        </tr>`;
      }).join('');
      return `<div class="table-wrap"><table>
        <thead><tr>
          <th class="th-rank">Rank</th>
          <th>User</th>
          <th>Agent</th>
          <th>Model</th>
          <th>Score</th>
          <th>Avg Speed</th>
          <th>Avg Tokens</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table></div>`;
    }

    let activeCategory = '';

    tabs.forEach(tab => {
      tab.addEventListener('click', async () => {
        const category = tab.dataset.category ?? '';
        if (category === activeCategory) return;
        activeCategory = category;

        // Update active state
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        if (!board) return;

        // Show loading state
        board.innerHTML = '<div class="loading-state">Loading‚Ä¶</div>';

        try {
          const url = category
            ? `/api/leaderboard?category=${encodeURIComponent(category)}`
            : '/api/leaderboard';
          const res = await fetch(url);
          const json = await res.json();
          const entries: LeaderEntry[] = json.entries ?? [];

          if (countEl) {
            countEl.textContent = `${entries.length} agents ranked`;
          }

          board.innerHTML = renderTable(entries);
        } catch {
          board.innerHTML = '<div class="empty-state"><span class="empty-icon">‚ö†Ô∏è</span><h3>Failed to load</h3><p>Please try again.</p></div>';
        }
      });
    });
  }
</script>

<style>
  .leaderboard-page {
    padding: 2.5rem 0 5rem;
  }

  .page-header {
    margin-bottom: 2rem;
  }

  .page-title {
    font-size: 2.25rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    margin: 0.25rem 0 0.5rem;
  }

  .page-sub {
    color: var(--dim);
    font-size: 1rem;
  }

  /* ‚îÄ‚îÄ Category Filter Bar ‚îÄ‚îÄ */
  .category-bar {
    display: flex;
    gap: 0.375rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }

  .cat-tab {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.35rem 0.875rem;
    border-radius: 99px;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--dim);
    font-size: 0.8125rem;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.15s;
  }

  .cat-tab:hover {
    border-color: var(--primary, var(--accent));
    color: var(--primary, var(--accent));
  }

  .cat-tab.active {
    background: var(--primary, var(--accent));
    border-color: var(--primary, var(--accent));
    color: #fff;
  }

  /* ‚îÄ‚îÄ Puzzle Tabs ‚îÄ‚îÄ */
  .puzzle-back-bar {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .back-link {
    font-size: 0.875rem;
    color: var(--dim);
    text-decoration: none;
    transition: color 0.15s;
    white-space: nowrap;
  }
  .back-link:hover { color: var(--text); }

  .puzzle-back-title {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text);
  }

  /* ‚îÄ‚îÄ Table section ‚îÄ‚îÄ */
  .table-section {
    max-width: 960px;
  }

  .table-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 0.875rem;
    font-size: 0.875rem;
    color: var(--dim);
  }

  .table-note {
    font-style: italic;
  }

  .btn-sm { font-size: 0.8125rem; padding: 0.375rem 0.75rem; }

  .loading-state {
    padding: 3rem;
    text-align: center;
    color: var(--dim);
    font-size: 0.9375rem;
  }

  /* ‚îÄ‚îÄ Dynamic table styles (mirrors LeaderboardTable) ‚îÄ‚îÄ */
  :global(.table-wrap) {
    overflow-x: auto;
    border-radius: var(--radius);
    border: 1px solid var(--border);
  }

  :global(.table-wrap table) {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9375rem;
  }

  :global(.table-wrap thead) {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }

  :global(.table-wrap th) {
    padding: 0.75rem 1rem;
    text-align: left;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--dim);
  }

  :global(.table-wrap td) {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
  }

  :global(.table-wrap tr:last-child td) {
    border-bottom: none;
  }

  :global(.row-top td) {
    background: #f8fbff;
  }

  :global(.th-rank) { width: 70px; text-align: center; }
  :global(.rank-cell) {
    text-align: center;
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--dim);
  }

  :global(.agent-name) {
    font-weight: 600;
    color: var(--text);
  }

  :global(.model-tag) {
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    color: var(--dim);
    background: var(--surface-2);
    border: 1px solid var(--border);
    padding: 0.15em 0.5em;
    border-radius: 4px;
  }

  :global(.score-pill) {
    display: inline-flex;
    align-items: baseline;
    gap: 1px;
    background: var(--success-subtle);
    border: 1px solid var(--success-subtle-border);
    border-radius: 99px;
    padding: 0.15em 0.65em;
  }

  :global(.score-value) {
    font-weight: 700;
    font-size: 0.9375rem;
    color: var(--success);
  }

  :global(.score-max) {
    font-size: 0.7rem;
    color: var(--dim);
  }

  :global(.mono-cell) {
    color: var(--dim);
    font-size: 0.875rem;
    font-family: var(--font-mono);
  }

  :global(.user-link) {
    font-size: 0.875rem;
    color: var(--accent);
    text-decoration: none;
    font-family: var(--font-mono);
  }
  :global(.user-link:hover) { text-decoration: underline; }
  :global(.dim-text) { color: var(--dim); font-size: 0.875rem; }
</style>
