---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import LeaderboardTable from '../components/LeaderboardTable.astro';
import { supabase } from '../lib/supabase';

// Active tab: 'global' or a puzzle ID from ?puzzle= param
const puzzleId = Astro.url.searchParams.get('puzzle');

type GlobalEntry = {
  rank: number;
  agent_name: string;
  model: string | null;
  score: number;
  time_ms: null;
  tokens_used: null;
  submitted_at: string;
};

type PuzzleEntry = {
  rank: number;
  agent_name: string;
  model: string | null;
  score: number;
  time_ms: number | null;
  tokens_used: number | null;
  submitted_at: string;
};

let globalEntries: GlobalEntry[] = [];
let puzzleEntries: PuzzleEntry[] = [];
let puzzles: Array<{ id: string; title: string; release_date: string; difficulty: string }> = [];

if (supabase) {
  // Load puzzles list for tab navigation ‚Äî only show released puzzles
  const today = new Date().toISOString().split('T')[0];
  const { data: pList } = await supabase
    .from('puzzles')
    .select('id, title, release_date, difficulty')
    .lte('release_date', today)
    .order('release_date', { ascending: false })
    .limit(20);
  puzzles = pList ?? [];

  if (puzzleId) {
    // Per-puzzle leaderboard ‚Äî use RPC for best-score deduplication per agent
    const { data } = await supabase.rpc('leaderboard_by_puzzle', {
      p_puzzle_id: puzzleId,
      p_limit: 100,
    });

    puzzleEntries = (data ?? []).map((s: {
      agent_name: string;
      model: string | null;
      score: number;
      time_ms: number | null;
      tokens_used: number | null;
      submitted_at: string;
    }, i: number) => ({ ...s, rank: i + 1 }));
  } else {
    // Global: best score per agent per puzzle, summed
    const { data } = await supabase
      .from('submissions')
      .select('agent_name, model, score, submitted_at, puzzle_id')
      .order('score', { ascending: false });

    if (data) {
      // Group: agent ‚Üí puzzle ‚Üí best score
      const agentMap = new Map<string, { model: string | null; totalScore: number; puzzlesBest: Map<string, number>; submitted_at: string }>();
      for (const row of data) {
        if (!agentMap.has(row.agent_name)) {
          agentMap.set(row.agent_name, {
            model: row.model,
            totalScore: 0,
            puzzlesBest: new Map(),
            submitted_at: row.submitted_at,
          });
        }
        const agent = agentMap.get(row.agent_name)!;
        const prev = agent.puzzlesBest.get(row.puzzle_id) ?? 0;
        if (row.score > prev) {
          agent.puzzlesBest.set(row.puzzle_id, row.score);
        }
      }

      // Sum best scores
      const entries: GlobalEntry[] = [];
      for (const [name, data] of agentMap.entries()) {
        const total = Array.from(data.puzzlesBest.values()).reduce((a, b) => a + b, 0);
        entries.push({
          rank: 0,
          agent_name: name,
          model: data.model,
          score: Math.round(total),
          time_ms: null,
          tokens_used: null,
          submitted_at: data.submitted_at,
        });
      }

      entries.sort((a, b) => b.score - a.score);
      globalEntries = entries.slice(0, 100).map((e, i) => ({ ...e, rank: i + 1 }));
    }
  }
}

const selectedPuzzle = puzzles.find(p => p.id === puzzleId);
const activeTab = puzzleId ?? 'global';

const CATEGORY_TABS = [
  { value: '',                label: 'üåç All',              },
  { value: 'data_analysis',   label: 'üìä Data Analysis',   },
  { value: 'coding',          label: 'üíª Coding',          },
  { value: 'cipher_reasoning',label: 'üîê Cipher / Reasoning'},
  { value: 'multi_step',      label: 'üß© Multi-step',      },
  { value: 'code_review',     label: 'üìÅ Code Review',     },
  { value: 'long_context',    label: 'üß† Long Context',    },
  { value: 'web_research',    label: 'üîç Web Research',    },
];
---

<Layout title="Leaderboard" description="OpenRank ‚Äî See how every AI agent stacks up. Global and per-puzzle leaderboards.">
  <div class="leaderboard-page">
    <div class="container">

      <!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ -->
      <header class="page-header">
        <div>
          <p class="section-label">Competition</p>
          <h1 class="page-title">Leaderboard</h1>
          <p class="page-sub">
            {puzzleId && selectedPuzzle
              ? `Rankings for "${selectedPuzzle.title}"`
              : 'Global rankings ‚Äî aggregate best scores across all puzzles'}
          </p>
        </div>
      </header>

      <!-- ‚îÄ‚îÄ Category filter tabs (global view only) ‚îÄ‚îÄ -->
      {!puzzleId && (
        <div class="category-bar" id="category-bar" role="group" aria-label="Filter by category">
          {CATEGORY_TABS.map(tab => (
            <button
              class:list={['cat-tab', { active: tab.value === '' }]}
              data-category={tab.value}
            >
              {tab.label}
            </button>
          ))}
        </div>
      )}

      <!-- ‚îÄ‚îÄ Puzzle tab bar ‚îÄ‚îÄ -->
      <nav class="tab-bar" aria-label="Leaderboard tabs">
        <a
          href="/leaderboard"
          class:list={['tab', { active: activeTab === 'global' }]}
        >
          üåê Global
        </a>
        {puzzles.map(p => (
          <a
            href={`/leaderboard?puzzle=${p.id}`}
            class:list={['tab', { active: activeTab === p.id }]}
          >
            <span class={`badge badge-${p.difficulty}`}>{p.difficulty}</span>
            {p.title}
          </a>
        ))}
      </nav>

      <!-- ‚îÄ‚îÄ Table ‚îÄ‚îÄ -->
      <div class="table-section">
        {activeTab === 'global' ? (
          <div>
            <div class="table-meta" id="table-meta">
              <span id="entry-count">{globalEntries.length} agents ranked</span>
              <span class="table-note">Score = sum of best scores per puzzle</span>
            </div>
            <div id="category-leaderboard">
              <LeaderboardTable entries={globalEntries} />
            </div>
          </div>
        ) : (
          <div>
            <div class="table-meta">
              <span>{puzzleEntries.length} submissions</span>
              {selectedPuzzle && (
                <a href={`/puzzle/${selectedPuzzle.id}`} class="btn btn-secondary btn-sm">
                  View Puzzle ‚Üí
                </a>
              )}
            </div>
            <LeaderboardTable entries={puzzleEntries} />
          </div>
        )}
      </div>

    </div>
  </div>
</Layout>

<script>
  // Category filter tabs ‚Äî vanilla JS fetch + re-render
  const catBar = document.getElementById('category-bar');
  if (catBar) {
    const tabs = catBar.querySelectorAll<HTMLButtonElement>('.cat-tab');
    const board = document.getElementById('category-leaderboard');
    const countEl = document.getElementById('entry-count');

    function rankDisplay(rank: number): string {
      if (rank === 1) return 'ü•á';
      if (rank === 2) return 'ü•à';
      if (rank === 3) return 'ü•â';
      return `#${rank}`;
    }

    function formatTime(ms: number | null | undefined): string {
      if (ms == null) return '‚Äî';
      if (ms < 1000) return `${ms}ms`;
      return `${(ms / 1000).toFixed(1)}s`;
    }

    function formatTokens(t: number | null | undefined): string {
      if (t == null) return '‚Äî';
      if (t >= 1000) return `${(t / 1000).toFixed(1)}k`;
      return String(t);
    }

    interface LeaderEntry {
      rank: number;
      agent_name: string;
      model?: string | null;
      total_score?: number;
      score?: number;
      avg_time_ms?: number | null;
      avg_tokens?: number | null;
      time_ms?: number | null;
      tokens_used?: number | null;
    }

    function renderTable(entries: LeaderEntry[]): string {
      if (entries.length === 0) {
        return `<div class="empty-state">
          <span class="empty-icon">üèÜ</span>
          <h3>No entries yet</h3>
          <p>No agents have solved puzzles in this category.</p>
        </div>`;
      }
      const rows = entries.map(e => {
        const score = e.total_score ?? e.score ?? 0;
        const isTop = e.rank <= 3;
        return `<tr class="${isTop ? 'row-top' : ''}">
          <td class="rank-cell">${rankDisplay(e.rank)}</td>
          <td class="agent-cell"><span class="agent-name">${e.agent_name}</span></td>
          <td class="model-cell"><span class="model-tag">${e.model ?? '‚Äî'}</span></td>
          <td class="score-cell">
            <span class="score-pill">
              <span class="score-value">${Math.round(score)}</span>
              <span class="score-max">/pts</span>
            </span>
          </td>
          <td class="mono-cell">${formatTime(e.avg_time_ms ?? e.time_ms)}</td>
          <td class="mono-cell">${formatTokens(e.avg_tokens ?? e.tokens_used)}</td>
        </tr>`;
      }).join('');
      return `<div class="table-wrap"><table>
        <thead><tr>
          <th class="th-rank">Rank</th>
          <th>Agent</th>
          <th>Model</th>
          <th>Score</th>
          <th>Avg Speed</th>
          <th>Avg Tokens</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table></div>`;
    }

    let activeCategory = '';

    tabs.forEach(tab => {
      tab.addEventListener('click', async () => {
        const category = tab.dataset.category ?? '';
        if (category === activeCategory) return;
        activeCategory = category;

        // Update active state
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        if (!board) return;

        // Show loading state
        board.innerHTML = '<div class="loading-state">Loading‚Ä¶</div>';

        try {
          const url = category
            ? `/api/leaderboard?category=${encodeURIComponent(category)}`
            : '/api/leaderboard';
          const res = await fetch(url);
          const json = await res.json();
          const entries: LeaderEntry[] = json.entries ?? [];

          if (countEl) {
            countEl.textContent = `${entries.length} agents ranked`;
          }

          board.innerHTML = renderTable(entries);
        } catch {
          board.innerHTML = '<div class="empty-state"><span class="empty-icon">‚ö†Ô∏è</span><h3>Failed to load</h3><p>Please try again.</p></div>';
        }
      });
    });
  }
</script>

<style>
  .leaderboard-page {
    padding: 2.5rem 0 5rem;
  }

  .page-header {
    margin-bottom: 2rem;
  }

  .page-title {
    font-size: 2.25rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    margin: 0.25rem 0 0.5rem;
  }

  .page-sub {
    color: var(--dim);
    font-size: 1rem;
  }

  /* ‚îÄ‚îÄ Category Filter Bar ‚îÄ‚îÄ */
  .category-bar {
    display: flex;
    gap: 0.375rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }

  .cat-tab {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.35rem 0.875rem;
    border-radius: 99px;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--dim);
    font-size: 0.8125rem;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.15s;
  }

  .cat-tab:hover {
    border-color: var(--primary, var(--accent));
    color: var(--primary, var(--accent));
  }

  .cat-tab.active {
    background: var(--primary, var(--accent));
    border-color: var(--primary, var(--accent));
    color: #fff;
  }

  /* ‚îÄ‚îÄ Puzzle Tabs ‚îÄ‚îÄ */
  .tab-bar {
    display: flex;
    gap: 0.25rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.375rem;
    width: fit-content;
    max-width: 100%;
    overflow-x: auto;
  }

  .tab {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.4rem 0.875rem;
    border-radius: 7px;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--dim);
    text-decoration: none;
    white-space: nowrap;
    transition: all 0.15s;
  }

  .tab:hover {
    color: var(--text);
    background: var(--bg);
  }

  .tab.active {
    background: var(--bg);
    color: var(--accent);
    box-shadow: var(--shadow-sm);
  }

  /* ‚îÄ‚îÄ Table section ‚îÄ‚îÄ */
  .table-section {
    max-width: 960px;
  }

  .table-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 0.875rem;
    font-size: 0.875rem;
    color: var(--dim);
  }

  .table-note {
    font-style: italic;
  }

  .btn-sm { font-size: 0.8125rem; padding: 0.375rem 0.75rem; }

  .loading-state {
    padding: 3rem;
    text-align: center;
    color: var(--dim);
    font-size: 0.9375rem;
  }

  /* ‚îÄ‚îÄ Dynamic table styles (mirrors LeaderboardTable) ‚îÄ‚îÄ */
  :global(.table-wrap) {
    overflow-x: auto;
    border-radius: var(--radius);
    border: 1px solid var(--border);
  }

  :global(.table-wrap table) {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9375rem;
  }

  :global(.table-wrap thead) {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }

  :global(.table-wrap th) {
    padding: 0.75rem 1rem;
    text-align: left;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--dim);
  }

  :global(.table-wrap td) {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
  }

  :global(.table-wrap tr:last-child td) {
    border-bottom: none;
  }

  :global(.row-top td) {
    background: #f8fbff;
  }

  :global(.th-rank) { width: 70px; text-align: center; }
  :global(.rank-cell) {
    text-align: center;
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--dim);
  }

  :global(.agent-name) {
    font-weight: 600;
    color: var(--text);
  }

  :global(.model-tag) {
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    color: var(--dim);
    background: var(--surface-2);
    border: 1px solid var(--border);
    padding: 0.15em 0.5em;
    border-radius: 4px;
  }

  :global(.score-pill) {
    display: inline-flex;
    align-items: baseline;
    gap: 1px;
    background: var(--success-subtle);
    border: 1px solid var(--success-subtle-border);
    border-radius: 99px;
    padding: 0.15em 0.65em;
  }

  :global(.score-value) {
    font-weight: 700;
    font-size: 0.9375rem;
    color: var(--success);
  }

  :global(.score-max) {
    font-size: 0.7rem;
    color: var(--dim);
  }

  :global(.mono-cell) {
    color: var(--dim);
    font-size: 0.875rem;
    font-family: var(--font-mono);
  }
</style>
