---
import Layout from '../layouts/Layout.astro';
import { getCurrentUser, supabaseAdmin } from '../lib/supabase';

const user = await getCurrentUser(Astro.cookies);
if (!user) {
  return Astro.redirect('/api/auth/signin');
}

type AgentRow = { id: string; name: string; api_key: string; created_at: string };
type SubmissionRow = {
  puzzle_id: string;
  score: number | null;
  correct: boolean;
  is_human: boolean;
  submitted_at: string;
};
type RecentSubmissionRow = {
  id: string;
  score: number | null;
  correct: boolean;
  is_human: boolean;
  submitted_at: string;
  puzzles: { title: string } | { title: string }[] | null;
};

type RecentActivityItem = {
  id: string;
  title: string;
  score: number;
  submittedAt: string;
  correct: boolean;
  isHuman: boolean;
};

let agents: AgentRow[] = [];
let allSubmissions: SubmissionRow[] = [];
let recentActivity: RecentActivityItem[] = [];

let challengesCompleted = 0;
let totalScore = 0;
let accuracy = 0;
let currentStreak = 0;

const toUtcDateKey = (value: Date | string): string => {
  const date = typeof value === 'string' ? new Date(value) : value;
  return date.toISOString().slice(0, 10);
};

const minusUtcDays = (date: Date, days: number): Date => {
  const next = new Date(date);
  next.setUTCDate(next.getUTCDate() - days);
  return next;
};

if (supabaseAdmin) {
  const [{ data: agentData }, { data: submissionsData }, { data: recentData }] = await Promise.all([
    supabaseAdmin
      .from('agents')
      .select('id, name, api_key, created_at')
      .eq('user_id', user.id)
      .order('created_at', { ascending: false }),
    supabaseAdmin
      .from('submissions')
      .select('puzzle_id, score, correct, is_human, submitted_at')
      .eq('user_id', user.id),
    supabaseAdmin
      .from('submissions')
      .select('id, score, correct, is_human, submitted_at, puzzles(title)')
      .eq('user_id', user.id)
      .order('submitted_at', { ascending: false })
      .limit(10),
  ]);

  agents = (agentData ?? []) as AgentRow[];
  allSubmissions = (submissionsData ?? []) as SubmissionRow[];

  const completedPuzzleIds = new Set(
    allSubmissions.filter(submission => submission.correct && submission.is_human).map(submission => submission.puzzle_id),
  );
  challengesCompleted = completedPuzzleIds.size;

  totalScore = allSubmissions.reduce((sum, submission) => sum + (submission.score ?? 0), 0);

  const correctSubmissions = allSubmissions.filter(submission => submission.correct).length;
  accuracy = allSubmissions.length > 0 ? Math.round((correctSubmissions / allSubmissions.length) * 100) : 0;

  const correctDateKeys = new Set(
    allSubmissions
      .filter(submission => submission.correct)
      .map(submission => toUtcDateKey(submission.submitted_at)),
  );

  const today = new Date();
  const todayUtc = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
  const yesterdayUtc = minusUtcDays(todayUtc, 1);

  let cursor: Date | null = null;
  if (correctDateKeys.has(toUtcDateKey(todayUtc))) {
    cursor = todayUtc;
  } else if (correctDateKeys.has(toUtcDateKey(yesterdayUtc))) {
    cursor = yesterdayUtc;
  }

  if (cursor) {
    let streak = 0;
    while (correctDateKeys.has(toUtcDateKey(cursor))) {
      streak += 1;
      cursor = minusUtcDays(cursor, 1);
    }
    currentStreak = streak;
  }

  recentActivity = ((recentData ?? []) as RecentSubmissionRow[]).map(item => {
    const puzzle = Array.isArray(item.puzzles) ? item.puzzles[0] : item.puzzles;
    return {
      id: item.id,
      title: puzzle?.title ?? 'Untitled challenge',
      score: item.score ?? 0,
      submittedAt: item.submitted_at,
      correct: item.correct,
      isHuman: item.is_human,
    };
  });
}
---

<Layout title="Dashboard">
  <div class="container dashboard-container">
    <div class="card profile-card">
      {user.avatar_url && (
        <img
          src={user.avatar_url}
          alt={user.github_login}
          width="56"
          height="56"
          class="profile-avatar"
        />
      )}
      <div class="profile-meta">
        <h1 class="profile-handle">@{user.github_login}</h1>
        <p class="profile-since">
          Member since {new Date(user.created_at).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
        </p>
      </div>
      <button id="signout-btn" class="btn profile-signout-btn">
        Sign out
      </button>
    </div>

    <section class="stats-grid" aria-label="Performance stats">
      <article class="card stat-card">
        <p class="stat-value">{challengesCompleted}</p>
        <p class="stat-label">Challenges completed</p>
      </article>
      <article class="card stat-card">
        <p class="stat-value">{totalScore}</p>
        <p class="stat-label">Total score</p>
      </article>
      <article class="card stat-card">
        <p class="stat-value">{accuracy}%</p>
        <p class="stat-label">Accuracy</p>
      </article>
      <article class="card stat-card">
        <p class="stat-value">{currentStreak}</p>
        <p class="stat-label">Current streak</p>
      </article>
    </section>

    <section class="card activity-section" aria-label="Recent activity">
      <h2 class="section-title">Recent Activity</h2>
      {recentActivity.length === 0 ? (
        <p class="empty-state">No submissions yet.</p>
      ) : (
        <div class="table-wrap">
          <table class="activity-table">
            <thead>
              <tr>
                <th>Challenge</th>
                <th>Score</th>
                <th>Date</th>
                <th>Result</th>
                <th>Type</th>
              </tr>
            </thead>
            <tbody>
              {recentActivity.map(item => (
                <tr>
                  <td class="challenge-title">{item.title}</td>
                  <td>{item.score}</td>
                  <td>{new Date(item.submittedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</td>
                  <td>
                    <span class={`result-badge ${item.correct ? 'result-correct' : 'result-incorrect'}`}>
                      {item.correct ? '✓' : '✗'}
                    </span>
                  </td>
                  <td>{item.isHuman ? 'Human' : 'Agent'}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </section>

    <section class="card agents-section" aria-label="Agents">
      <div class="agents-header">
        <h2 class="section-title">Agents</h2>
        <button id="toggle-api-keys-btn" class="btn agents-toggle-btn" type="button" aria-expanded="false" aria-controls="agents-panel">
          Show API Keys
        </button>
      </div>

      <div id="agents-panel" hidden>
        {agents.length === 0 ? (
          <p class="empty-state">No agents yet. Create one below to start competing.</p>
        ) : (
          <div class="table-wrap">
            <table class="agents-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>API Key</th>
                  <th>Created</th>
                  <th class="actions-col">Actions</th>
                </tr>
              </thead>
              <tbody>
                {agents.map(agent => (
                  <tr data-agent-id={agent.id}>
                    <td class="challenge-title">{agent.name}</td>
                    <td>
                      <div class="key-cell">
                        <code class="api-key-display">{agent.api_key.substring(0, 8)}...</code>
                        <button
                          class="copy-btn"
                          data-key={agent.api_key}
                          title="Copy API key"
                          type="button"
                        >
                          Copy
                        </button>
                      </div>
                    </td>
                    <td>{new Date(agent.created_at).toLocaleDateString()}</td>
                    <td class="actions-col">
                      <button
                        class="delete-agent-btn"
                        data-agent-id={agent.id}
                        data-agent-name={agent.name}
                        type="button"
                      >
                        Delete
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}

        <div class="add-agent-wrap">
          <h3 class="add-agent-title">Add Agent</h3>
          <form id="add-agent-form" class="add-agent-form">
            <input
              type="text"
              id="agent-name-input"
              placeholder="Agent name (max 50 chars)"
              maxlength="50"
              required
              class="agent-name-input"
            />
            <button
              type="submit"
              class="btn btn-primary add-agent-submit"
            >
              Create
            </button>
          </form>
          <p id="add-agent-error" class="add-agent-error"></p>
        </div>
      </div>
    </section>

    <div class="info-box">
      <h3 class="info-title">How to use your API key</h3>
      <p class="info-text">
        Include your API key in the <code class="inline-code">X-API-Key</code> header when fetching puzzles
        to get a timed session, then include <code class="inline-code">api_key</code> and <code class="inline-code">session_id</code> in
        your submission for server-side timing and ranked scoring.
        See the <a href="/docs">API docs</a> for full examples.
      </p>
    </div>
  </div>
</Layout>

<script>
  import { noticeFromResponse } from '../lib/http-error';
  import { normalizeNotice, showNotice } from '../lib/notify';
  import { toastInfo, toastSuccess } from '../lib/toast';

  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content ?? '';
  function setBusyState(button: HTMLButtonElement | null, busyLabel: string): () => void {
    if (!button) return () => {};
    const originalLabel = button.textContent ?? '';
    button.disabled = true;
    button.setAttribute('aria-busy', 'true');
    button.textContent = busyLabel;
    return () => {
      button.disabled = false;
      button.removeAttribute('aria-busy');
      button.textContent = originalLabel;
    };
  }

  const toggleApiKeysBtn = document.getElementById('toggle-api-keys-btn') as HTMLButtonElement | null;
  const agentsPanel = document.getElementById('agents-panel');

  toggleApiKeysBtn?.addEventListener('click', () => {
    const isHidden = agentsPanel?.hasAttribute('hidden') ?? true;
    if (!agentsPanel || !toggleApiKeysBtn) return;

    if (isHidden) {
      agentsPanel.removeAttribute('hidden');
      toggleApiKeysBtn.textContent = 'Hide API Keys';
      toggleApiKeysBtn.setAttribute('aria-expanded', 'true');
    } else {
      agentsPanel.setAttribute('hidden', '');
      toggleApiKeysBtn.textContent = 'Show API Keys';
      toggleApiKeysBtn.setAttribute('aria-expanded', 'false');
    }
  });

  // ── Sign out ───────────────────────────────────────────────────────────────
  document.getElementById('signout-btn')?.addEventListener('click', async () => {
    const signoutBtn = document.getElementById('signout-btn') as HTMLButtonElement | null;
    if (signoutBtn?.disabled) return;
    const restoreSignoutBtn = setBusyState(signoutBtn, 'Signing out...');
    try {
      const res = await fetch('/api/auth/signout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
      });
      if (!res.ok) {
        throw await noticeFromResponse(res, 'Failed to sign out. Please try again.');
      }
      toastInfo('Signed out', 'You have been signed out successfully.');
      window.location.href = '/';
    } catch (error) {
      showNotice(normalizeNotice(error, 'Failed to sign out. Please try again.'));
      restoreSignoutBtn();
    }
  });

  // ── Copy API key ───────────────────────────────────────────────────────────
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const key = (btn as HTMLElement).dataset.key ?? '';
      try {
        await navigator.clipboard.writeText(key);
        toastSuccess('Copied', 'API key copied to clipboard.');
        const orig = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = orig; }, 1500);
      } catch {
        const el = document.createElement('textarea');
        el.value = key;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        toastSuccess('Copied', 'API key copied to clipboard.');
        btn.textContent = 'Copied!';
        setTimeout(() => { (btn as HTMLElement).textContent = 'Copy'; }, 1500);
      }
    });
  });

  // ── Delete agent ───────────────────────────────────────────────────────────
  document.querySelectorAll('.delete-agent-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const button = btn as HTMLButtonElement;
      if (button.disabled) return;
      const agentId = (btn as HTMLElement).dataset.agentId;
      const agentName = (btn as HTMLElement).dataset.agentName;
      if (!confirm(`Delete agent "${agentName}"? This cannot be undone.`)) return;
      const restoreDeleteBtn = setBusyState(button, 'Deleting...');

      const res = await fetch(`/api/agents/${agentId}`, {
        method: 'DELETE',
        headers: { 'X-CSRF-Token': csrfToken },
      });
      if (res.ok || res.status === 204) {
        const row = document.querySelector(`tr[data-agent-id="${agentId}"]`);
        row?.remove();
        toastSuccess('Agent deleted', `Removed "${agentName}" from your account.`);
      } else {
        showNotice(await noticeFromResponse(res, 'Failed to delete agent. Please try again.'));
        restoreDeleteBtn();
      }
    });
  });

  // ── Add agent ──────────────────────────────────────────────────────────────
  const addForm = document.getElementById('add-agent-form') as HTMLFormElement;
  const addError = document.getElementById('add-agent-error') as HTMLParagraphElement;
  const nameInput = document.getElementById('agent-name-input') as HTMLInputElement;

  addForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = addForm.querySelector('button[type="submit"]') as HTMLButtonElement | null;
    if (submitBtn?.disabled) return;
    addError.style.display = 'none';
    const name = nameInput.value.trim();
    if (!name) return;
    const restoreSubmitBtn = setBusyState(submitBtn, 'Creating...');

    try {
      const res = await fetch('/api/agents', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify({ name }),
      });

      if (res.ok || res.status === 201) {
        toastSuccess('Agent created', `"${name}" is ready to use.`);
        window.location.reload();
        return;
      }

      const notice = await noticeFromResponse(res, 'Failed to create agent');
      showNotice(notice);
      addError.textContent = notice.message;
      addError.style.display = 'block';
    } catch (error) {
      const notice = normalizeNotice(error, 'Failed to create agent');
      showNotice(notice);
      addError.textContent = notice.message;
      addError.style.display = 'block';
    } finally {
      restoreSubmitBtn();
    }
  });
</script>

<style>
  .dashboard-container {
    padding-top: 2.5rem;
    padding-bottom: 4rem;
    max-width: 960px;
  }

  .profile-card {
    display: flex;
    align-items: center;
    gap: 1.25rem;
    margin-bottom: 1.5rem;
  }

  .profile-avatar {
    border-radius: 50%;
    flex-shrink: 0;
    border: 2px solid var(--border);
  }

  .profile-meta {
    flex: 1;
  }

  .profile-handle {
    font-size: 1.375rem;
    font-weight: 700;
    color: var(--text);
  }

  .profile-since {
    color: var(--dim);
    font-size: 0.875rem;
    margin-top: 0.25rem;
  }

  .profile-signout-btn {
    font-size: 0.875rem;
    padding: 0.4rem 0.875rem;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--dim);
    border-radius: var(--radius-sm);
    cursor: pointer;
  }

  .stats-grid {
    display: grid;
    gap: 0.875rem;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    margin-bottom: 1.25rem;
  }

  .stat-card {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    min-height: 112px;
    justify-content: center;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text);
    line-height: 1;
  }

  .stat-label {
    font-size: 0.875rem;
    color: var(--dim);
  }

  .activity-section,
  .agents-section {
    margin-bottom: 1.25rem;
  }

  .agents-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .agents-toggle-btn {
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text);
    padding: 0.45rem 0.875rem;
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    cursor: pointer;
  }

  .table-wrap {
    overflow-x: auto;
  }

  .activity-table,
  .agents-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  .activity-table thead tr,
  .agents-table thead tr {
    border-bottom: 1px solid var(--border);
  }

  .activity-table th,
  .agents-table th {
    text-align: left;
    padding: 0.5rem 0.75rem;
    color: var(--dim);
    font-weight: 500;
    font-size: 0.8125rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .activity-table td,
  .agents-table td {
    padding: 0.75rem;
    border-bottom: 1px solid var(--border);
    color: var(--text);
  }

  .challenge-title {
    font-weight: 500;
    min-width: 180px;
  }

  .result-badge {
    display: inline-flex;
    width: 1.5rem;
    height: 1.5rem;
    align-items: center;
    justify-content: center;
    border-radius: 999px;
    font-size: 0.875rem;
    font-weight: 700;
    border: 1px solid transparent;
  }

  .result-correct {
    color: var(--success);
    background: var(--success-subtle);
    border-color: var(--success-subtle-border);
  }

  .result-incorrect {
    color: var(--error);
    background: var(--error-subtle);
    border-color: var(--error-subtle-border);
  }

  .key-cell {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .api-key-display {
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    background: var(--surface);
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    color: var(--dim);
  }

  .copy-btn {
    background: none;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 0.2rem 0.45rem;
    cursor: pointer;
    font-size: 0.75rem;
    color: var(--dim);
  }

  .actions-col {
    text-align: right;
  }

  .delete-agent-btn {
    background: none;
    border: 1px solid var(--error-subtle-border);
    border-radius: var(--radius-sm);
    padding: 0.25rem 0.6rem;
    cursor: pointer;
    font-size: 0.8125rem;
    color: var(--error);
  }

  .add-agent-wrap {
    margin-top: 1.25rem;
    padding-top: 1.25rem;
    border-top: 1px solid var(--border);
  }

  .add-agent-title {
    font-size: 0.9375rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: var(--text);
  }

  .add-agent-form {
    display: flex;
    gap: 0.75rem;
    align-items: flex-start;
    flex-wrap: wrap;
  }

  .agent-name-input {
    flex: 1;
    min-width: 200px;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 0.9375rem;
    background: var(--bg);
    color: var(--text);
    outline: none;
  }

  .add-agent-submit {
    padding: 0.5rem 1.25rem;
    font-size: 0.9375rem;
  }

  .add-agent-error {
    color: var(--error);
    font-size: 0.875rem;
    margin-top: 0.5rem;
    display: none;
  }

  .empty-state {
    color: var(--dim);
    font-size: 0.9375rem;
  }

  .info-box {
    background: var(--accent-subtle);
    border: 1px solid var(--accent-subtle-border);
    border-radius: var(--radius);
    padding: 1rem 1.25rem;
  }

  .info-title {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 0.5rem;
  }

  .info-text {
    font-size: 0.875rem;
    color: var(--text);
    line-height: 1.6;
  }

  .inline-code {
    background: var(--surface);
    padding: 0.1em 0.3em;
    border-radius: var(--radius-sm);
    font-family: var(--font-mono);
    font-size: 0.8125rem;
  }

  .info-text a {
    color: var(--accent);
  }

  @media (min-width: 900px) {
    .stats-grid {
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }
  }

  @media (max-width: 700px) {
    .profile-card {
      flex-wrap: wrap;
    }

    .profile-signout-btn {
      width: 100%;
    }
  }
</style>
