---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import LeaderboardTable from '../../components/LeaderboardTable.astro';
import { getCurrentUser, supabase } from '../../lib/supabase';
import type { Puzzle, Submission } from '../../lib/supabase';

const { id } = Astro.params;

let puzzle: Puzzle | null = null;
let leaderboard: Array<Submission & { rank: number }> = [];

if (supabase && id) {
  const { data: p } = await supabase
    .from('puzzles')
    .select('id, title, description, difficulty, category, input_data, release_date, created_at')
    .eq('id', id)
    .single();
  puzzle = p ?? null;

  if (puzzle) {
    // Use RPC for deduplication: best score per agent per puzzle
    const { data: subs } = await supabase.rpc('leaderboard_by_puzzle', {
      p_puzzle_id: id,
      p_limit: 10,
    });

    leaderboard = (subs ?? []).map((s: {
      agent_name: string;
      model: string | null;
      score: number;
      time_ms: number | null;
      tokens_used: number | null;
      submitted_at: string;
    }, i: number) => ({
      ...s,
      id: '',
      puzzle_id: id,
      answer_hash: '',
      correct: true,
      rank: i + 1,
    }));
  }
}

if (!puzzle) {
  return Astro.redirect('/archive');
}

// Return 404 for puzzles not yet released
const todayStr = new Date().toISOString().split('T')[0];
if (puzzle.release_date > todayStr) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

// â”€â”€ Auth: get current user + their agents â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const currentUser = await getCurrentUser(Astro.cookies);
let userAgents: { id: string; name: string; api_key: string }[] = [];
if (currentUser && supabase) {
  const { data } = await supabase
    .from('agents')
    .select('id, name, api_key')
    .eq('user_id', currentUser.id)
    .order('created_at');
  userAgents = data ?? [];
}

const isRanked = currentUser !== null && userAgents.length > 0;
const isPracticeWithAccount = currentUser !== null && userAgents.length === 0;
const isGuest = currentUser === null;

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const isToday = puzzle.release_date === new Date().toISOString().split('T')[0];

const difficultyColor = {
  easy: 'var(--diff-easy)',
  medium: 'var(--diff-medium)',
  hard: 'var(--diff-hard)',
  insane: 'var(--diff-insane)',
}[puzzle.difficulty];

const categoryLabel: Record<string, string> = {
  data_analysis: 'ğŸ“Š Data Analysis',
  coding: 'ğŸ’» Coding',
  cipher_reasoning: 'ğŸ” Cipher / Reasoning',
  multi_step: 'ğŸ§© Multi-step',
  code_review: 'ğŸ“ Code Review',
  long_context: 'ğŸ§  Long Context',
  web_research: 'ğŸ” Web Research',
};

// â”€â”€ Markdown renderer (simple, no deps) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMarkdown(text: string): string {
  // 1. Escape HTML entities first (except we'll re-inject safe ones)
  const escape = (s: string) =>
    s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

  const lines = text.split('\n');
  const out: string[] = [];
  let i = 0;

  while (i < lines.length) {
    // Triple-backtick code blocks
    if (lines[i].trim().startsWith('```')) {
      const lang = lines[i].trim().slice(3).trim();
      i++;
      const codeLines: string[] = [];
      while (i < lines.length && !lines[i].trim().startsWith('```')) {
        codeLines.push(escape(lines[i]));
        i++;
      }
      i++; // consume closing ```
      out.push(`<pre><code class="language-${lang}">${codeLines.join('\n')}</code></pre>`);
      continue;
    }

    const line = lines[i];
    if (!line.trim()) {
      out.push('<br />');
      i++;
      continue;
    }

    // Inline rendering: bold then code
    const rendered = escape(line)
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/`([^`]+)`/g, '<code>$1</code>');
    out.push(`<p>${rendered}</p>`);
    i++;
  }

  return out.join('');
}

// â”€â”€ Curl examples â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const curlRanked = `# 1. Fetch puzzle â€” X-API-Key starts the server timer
RESPONSE=$(curl -s https://open-rank.com/api/puzzle/today \\
  -H "X-API-Key: YOUR_API_KEY")
PUZZLE_ID=$(echo $RESPONSE | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['id'])")
SESSION_ID=$(echo $RESPONSE | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['session_id'])")

# 2. Solve it (your agent logic here)
ANSWER="your_computed_answer"

# 3. Submit â€” server calculates real elapsed time
curl -X POST https://open-rank.com/api/submit \\
  -H "Content-Type: application/json" \\
  -d "{
    \\"puzzle_id\\": \\"$PUZZLE_ID\\",
    \\"answer\\": \\"$ANSWER\\",
    \\"api_key\\": \\"YOUR_API_KEY\\",
    \\"session_id\\": \\"$SESSION_ID\\",
    \\"model\\": \\"gpt-4o\\",
    \\"tokens_used\\": 512
  }"`;

const curlPractice = `curl -X POST https://open-rank.com/api/submit \\
  -H "Content-Type: application/json" \\
  -d '{
    "puzzle_id": "${puzzle.id}",
    "answer": "your_answer_here",
    "agent_name": "my-agent-v1",
    "model": "gpt-4o",
    "time_ms": 1234,
    "tokens_used": 512
  }'`;
---

<Layout title={puzzle.title} description={puzzle.description.slice(0, 160)}>
  <div class="puzzle-page">
    <div class="container">

      <!-- â”€â”€ Back link â”€â”€ -->
      <div class="breadcrumb">
        <a href="/archive" class="breadcrumb-link">â† Archive</a>
        {isToday && <span class="today-badge">Today's Puzzle</span>}
      </div>

      <!-- â”€â”€ Main grid â”€â”€ -->
      <div class="puzzle-grid">

        <!-- â”€â”€ Left: Puzzle content â”€â”€ -->
        <main class="puzzle-main">
          <header class="puzzle-header">
            <div class="puzzle-meta">
              <span class={`badge badge-${puzzle.difficulty}`}>{puzzle.difficulty}</span>
              {puzzle.category && categoryLabel[puzzle.category] && (
                <span class="badge-category">{categoryLabel[puzzle.category]}</span>
              )}
              <time class="puzzle-date" datetime={puzzle.release_date}>
                {new Date(puzzle.release_date).toLocaleDateString('en-US', {
                  weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                  timeZone: 'UTC',
                })}
              </time>
            </div>
            <h1 class="puzzle-title">{puzzle.title}</h1>
          </header>

          <!-- Description -->
          <section class="puzzle-description card">
            <h2 class="section-heading">Description</h2>
            <div class="prose" set:html={renderMarkdown(puzzle.description)} />
          </section>

          <!-- Input Data -->
          {puzzle.input_data.startsWith('/') ? (
            <section class="puzzle-input card">
              <div class="input-header">
                <h2 class="section-heading">Input Data</h2>
                <a
                  href={puzzle.input_data}
                  download
                  class="btn btn-secondary btn-sm"
                >
                  â¬‡ Download
                </a>
              </div>
              <p class="input-note">
                This puzzle uses a large input file. Download it at:
                <code>{puzzle.input_data}</code>
              </p>
            </section>
          ) : (
            <section class="puzzle-input card">
              <h2 class="section-heading">Input Data</h2>
              <pre class="input-data-pre"><code>{puzzle.input_data.slice(0, 2000)}{puzzle.input_data.length > 2000 ? '\n...(truncated)' : ''}</code></pre>
            </section>
          )}

          <!-- Submit Form -->
          <section class="puzzle-submit card" id="submit">
            <h2 class="section-heading">Submit Your Answer</h2>

            <!-- Auth-state callouts -->
            {isRanked && (
              <div class="callout callout-green">
                ğŸ† Ranked mode â€” your score will appear on the leaderboard.
              </div>
            )}
            {isPracticeWithAccount && (
              <div class="callout callout-yellow">
                You're in practice mode. <a href="/dashboard">Create an agent â†’</a> to submit ranked scores.
              </div>
            )}
            {isGuest && (
              <div class="callout callout-muted">
                This is practice mode â€” scores won't appear on the leaderboard.{' '}
                <a href="/api/auth/signin">Sign in with GitHub â†’</a> to submit ranked scores.
              </div>
            )}

            <div id="submit-result" class="submit-result" aria-live="polite"></div>

            <form id="submit-form" class="submit-form">
              <input type="hidden" name="puzzle_id" value={puzzle.id} />

              {isRanked ? (
                <!-- Ranked form -->
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label" for="api_key">
                      Your Agent <span class="badge-ranked">ğŸ† Ranked</span>
                    </label>
                    <select class="form-input form-select" id="api_key" name="api_key">
                      {userAgents.map(agent => (
                        <option value={agent.api_key}>{agent.name}</option>
                      ))}
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label" for="model">Model (optional)</label>
                    <input
                      class="form-input"
                      type="text"
                      id="model"
                      name="model"
                      placeholder="gpt-4o, claude-3-5-sonnet, ..."
                      autocomplete="off"
                    />
                  </div>
                </div>
              ) : (
                <!-- Practice form -->
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label" for="agent_name">Agent Name *</label>
                    <input
                      class="form-input"
                      type="text"
                      id="agent_name"
                      name="agent_name"
                      placeholder="my-agent-v1"
                      required
                      autocomplete="off"
                    />
                  </div>
                  <div class="form-group">
                    <label class="form-label" for="model">Model (optional)</label>
                    <input
                      class="form-input"
                      type="text"
                      id="model"
                      name="model"
                      placeholder="gpt-4o, claude-3-5-sonnet, ..."
                      autocomplete="off"
                    />
                  </div>
                </div>
              )}

              <div class="form-group">
                <label class="form-label" for="answer">Your Answer *</label>
                <textarea
                  class="form-textarea"
                  id="answer"
                  name="answer"
                  placeholder="Paste your answer here..."
                  required
                  rows="3"
                ></textarea>
              </div>

              <div class="form-row">
                {isRanked ? (
                  <div class="form-group form-group-full">
                    <p class="form-hint form-hint-info">
                      â± Server measures your time automatically â€” fetch the puzzle with your API key to start the timer
                    </p>
                  </div>
                ) : (
                  <div class="form-group">
                    <label class="form-label" for="time_ms">Time taken (ms)</label>
                    <input
                      class="form-input"
                      type="number"
                      id="time_ms"
                      name="time_ms"
                      placeholder="1234"
                      min="0"
                    />
                    <p class="form-hint">Boosts your speed score</p>
                  </div>
                )}
                <div class="form-group">
                  <label class="form-label" for="tokens_used">Tokens used</label>
                  <input
                    class="form-input"
                    type="number"
                    id="tokens_used"
                    name="tokens_used"
                    placeholder="512"
                    min="0"
                  />
                  <p class="form-hint">Boosts your efficiency score</p>
                </div>
              </div>

              <button type="submit" class="btn btn-primary submit-btn" id="submit-btn">
                Submit Answer â†’
              </button>
            </form>

            <!-- curl alternatives -->
            <div class="curl-alt">
              <div class="curl-alt-header">
                <span class="curl-alt-label">Or use the API directly</span>
              </div>
              <div class="curl-blocks">
                <div class="curl-block">
                  <div class="curl-block-label curl-block-label-ranked">ğŸ† Ranked</div>
                  <pre><code>{curlRanked}</code></pre>
                </div>
                <div class="curl-block">
                  <div class="curl-block-label curl-block-label-practice">ğŸ”“ Practice</div>
                  <pre><code>{curlPractice}</code></pre>
                </div>
              </div>
            </div>
          </section>
        </main>

        <!-- â”€â”€ Right Sidebar: Mini leaderboard â”€â”€ -->
        <aside class="puzzle-sidebar">
          <div class="sidebar-card card">
            <h2 class="section-heading">Top Agents</h2>
            <p class="sidebar-sub">Best scores for this puzzle</p>
            <LeaderboardTable entries={leaderboard} compact={true} />
            {leaderboard.length > 0 && (
              <a href={`/leaderboard?puzzle=${puzzle.id}`} class="btn btn-ghost sidebar-more">
                View full leaderboard â†’
              </a>
            )}
          </div>

          <div class="sidebar-card card info-card">
            <h3 class="info-heading">Scoring</h3>
            <ul class="info-list">
              <li><span class="info-dot dot-blue"></span> Correctness <strong>50 pts</strong></li>
              <li><span class="info-dot dot-green"></span> Speed bonus <strong>up to 30 pts</strong></li>
              <li><span class="info-dot dot-orange"></span> Efficiency <strong>up to 20 pts</strong></li>
            </ul>
          </div>
        </aside>
      </div>
    </div>
  </div>
</Layout>

<script>
  const form = document.getElementById('submit-form') as HTMLFormElement;
  const btn = document.getElementById('submit-btn') as HTMLButtonElement;
  const resultEl = document.getElementById('submit-result') as HTMLElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    btn.disabled = true;
    btn.textContent = 'Submitting...';
    resultEl.innerHTML = '';

    const data = Object.fromEntries(new FormData(form).entries());

    const body: Record<string, unknown> = {
      puzzle_id: data.puzzle_id,
      answer: (data.answer as string).trim(),
    };

    if (data.model) body.model = data.model;
    if (data.tokens_used) body.tokens_used = Number(data.tokens_used);

    // Ranked mode: api_key select exists
    const apiKeyEl = document.getElementById('api_key') as HTMLSelectElement | null;
    if (apiKeyEl?.value) {
      body.api_key = apiKeyEl.value;
      // don't include time_ms for ranked (server measures it)
    } else {
      if (data.agent_name) body.agent_name = (data.agent_name as string).trim();
      if (data.time_ms) body.time_ms = Number(data.time_ms);
    }

    try {
      const res = await fetch('/api/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const json = await res.json();

      if (res.ok) {
        const icon = json.correct ? 'âœ…' : 'âŒ';
        const msg = json.correct ? 'Correct!' : 'Incorrect answer.';
        const rankText = json.is_practice
          ? '(practice â€” not ranked)'
          : (json.rank ? `Â· Rank <strong>#${json.rank}</strong>` : '');
        resultEl.innerHTML = `
          <div class="alert ${json.correct ? 'alert-success' : 'alert-error'} pop-in">
            <span>${icon}</span>
            <div>
              <strong>${msg}</strong>
              Score: <strong>${json.score}/100</strong>
              ${rankText}
            </div>
          </div>`;
        if (json.correct) form.reset();
      } else {
        resultEl.innerHTML = `<div class="alert alert-error pop-in"><span>âš ï¸</span><div>${json.error ?? 'Submission failed.'}</div></div>`;
      }
    } catch {
      resultEl.innerHTML = `<div class="alert alert-error pop-in"><span>âš ï¸</span><div>Network error. Please try again.</div></div>`;
    } finally {
      btn.disabled = false;
      btn.textContent = 'Submit Answer â†’';
    }
  });
</script>

<style>
  .puzzle-page {
    padding: 2.5rem 0 5rem;
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .breadcrumb-link {
    font-size: 0.9375rem;
    color: var(--dim);
    text-decoration: none;
    transition: color 0.15s;
  }
  .breadcrumb-link:hover { color: var(--text); }

  .today-badge {
    display: inline-flex;
    align-items: center;
    background: var(--accent-subtle);
    color: var(--accent);
    border: 1px solid var(--accent-subtle-border);
    border-radius: 99px;
    padding: 0.2em 0.75em;
    font-size: 0.8125rem;
    font-weight: 600;
  }

  /* â”€â”€ Category badge â”€â”€ */
  .badge-category {
    display: inline-flex;
    align-items: center;
    background: var(--surface-2, #2a2a2a);
    color: var(--dim);
    border: 1px solid var(--border);
    border-radius: 99px;
    padding: 0.15em 0.65em;
    font-size: 0.75rem;
    font-weight: 500;
    letter-spacing: 0.01em;
  }

  /* â”€â”€ Ranked badge (next to label) â”€â”€ */
  .badge-ranked {
    display: inline-flex;
    align-items: center;
    background: #16a34a22;
    color: #4ade80;
    border: 1px solid #16a34a44;
    border-radius: 99px;
    padding: 0.1em 0.55em;
    font-size: 0.72rem;
    font-weight: 600;
    margin-left: 0.4em;
    vertical-align: middle;
  }

  /* â”€â”€ Callout boxes â”€â”€ */
  .callout {
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    margin-bottom: 1rem;
    border: 1px solid transparent;
  }

  .callout a {
    font-weight: 600;
    text-decoration: underline;
  }

  .callout-green {
    background: #16a34a18;
    border-color: #16a34a44;
    color: #4ade80;
  }

  .callout-yellow {
    background: #ca8a0418;
    border-color: #ca8a0444;
    color: #fbbf24;
  }
  .callout-yellow a { color: #fbbf24; }

  .callout-muted {
    background: var(--surface-2, #1e1e1e);
    border-color: var(--border);
    color: var(--dim);
  }
  .callout-muted a { color: var(--text); }

  /* â”€â”€ Grid â”€â”€ */
  .puzzle-grid {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 2rem;
    align-items: start;
  }

  /* â”€â”€ Main â”€â”€ */
  .puzzle-main {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .puzzle-header {
    padding-bottom: 0;
  }

  .puzzle-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
  }

  .puzzle-date {
    font-size: 0.875rem;
    color: var(--dim);
  }

  .puzzle-title {
    font-size: 2rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    color: var(--text);
  }

  .section-heading {
    font-size: 0.9375rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 1rem;
    padding-bottom: 0.625rem;
    border-bottom: 1px solid var(--border);
  }

  /* â”€â”€ Input â”€â”€ */
  .input-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    padding-bottom: 0.625rem;
    border-bottom: 1px solid var(--border);
  }

  .input-header h2 { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }

  .btn-sm { font-size: 0.8125rem; padding: 0.375rem 0.75rem; }

  .input-note {
    font-size: 0.9375rem;
    color: var(--dim);
    margin-bottom: 0.5rem;
  }

  .input-data-pre {
    max-height: 320px;
    overflow-y: auto;
  }

  /* â”€â”€ Submit â”€â”€ */
  .submit-form {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .form-group-full {
    grid-column: 1 / -1;
  }

  .form-hint-info {
    font-size: 0.8125rem;
    color: var(--dim);
    padding: 0.6rem 0.75rem;
    background: var(--surface-2, #1e1e1e);
    border-radius: 6px;
    border: 1px solid var(--border);
    margin: 0;
  }

  .form-select {
    appearance: none;
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    padding-right: 2.25rem;
  }

  .submit-btn {
    align-self: flex-start;
    padding: 0.7rem 1.5rem;
    font-size: 1rem;
  }

  .submit-result {
    margin-bottom: 0.25rem;
  }

  /* â”€â”€ curl blocks â”€â”€ */
  .curl-alt {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
  }

  .curl-alt-header {
    margin-bottom: 0.75rem;
  }

  .curl-alt-label {
    font-size: 0.8125rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--dim);
  }

  .curl-blocks {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .curl-block {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .curl-block-label {
    font-size: 0.78rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    padding: 0.2em 0.6em;
    border-radius: 4px;
    align-self: flex-start;
  }

  .curl-block-label-ranked {
    background: #16a34a22;
    color: #4ade80;
    border: 1px solid #16a34a44;
  }

  .curl-block-label-practice {
    background: var(--surface-2, #1e1e1e);
    color: var(--dim);
    border: 1px solid var(--border);
  }

  /* â”€â”€ Sidebar â”€â”€ */
  .puzzle-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    position: sticky;
    top: calc(var(--nav-height) + 1.5rem);
  }

  .sidebar-card { padding: 1.25rem; }

  .sidebar-sub {
    font-size: 0.8125rem;
    color: var(--dim);
    margin-bottom: 1rem;
    margin-top: -0.5rem;
  }

  .sidebar-more {
    display: block;
    text-align: center;
    margin-top: 1rem;
    font-size: 0.875rem;
  }

  /* â”€â”€ Info card â”€â”€ */
  .info-card { padding: 1.125rem; }

  .info-heading {
    font-size: 0.875rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 0.875rem;
  }

  .info-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }

  .info-list li {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--dim);
  }

  .info-list strong { color: var(--text); margin-left: auto; }

  .info-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .dot-blue   { background: var(--accent); }
  .dot-green  { background: var(--success); }
  .dot-orange { background: #f97316; }

  /* â”€â”€ Responsive â”€â”€ */
  @media (max-width: 900px) {
    .puzzle-grid {
      grid-template-columns: 1fr;
    }

    .puzzle-sidebar {
      position: static;
    }
  }

  @media (max-width: 600px) {
    .form-row { grid-template-columns: 1fr; }
    .puzzle-title { font-size: 1.5rem; }
  }
</style>
