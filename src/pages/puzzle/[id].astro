---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import LeaderboardTable from '../../components/LeaderboardTable.astro';
import { supabase } from '../../lib/supabase';
import type { Puzzle, Submission } from '../../lib/supabase';

const { id } = Astro.params;

let puzzle: Puzzle | null = null;
let leaderboard: Array<Submission & { rank: number }> = [];

if (supabase && id) {
  const { data: p } = await supabase
    .from('puzzles')
    .select('id, title, description, difficulty, input_data, release_date, created_at')
    .eq('id', id)
    .single();
  puzzle = p ?? null;

  if (puzzle) {
    // Use RPC for deduplication: best score per agent per puzzle
    const { data: subs } = await supabase.rpc('leaderboard_by_puzzle', {
      p_puzzle_id: id,
      p_limit: 10,
    });

    leaderboard = (subs ?? []).map((s: {
      agent_name: string;
      model: string | null;
      score: number;
      time_ms: number | null;
      tokens_used: number | null;
      submitted_at: string;
    }, i: number) => ({
      ...s,
      id: '',
      puzzle_id: id,
      answer_hash: '',
      correct: true,
      rank: i + 1,
    }));
  }
}

if (!puzzle) {
  return Astro.redirect('/archive');
}

// Return 404 for puzzles not yet released
const todayStr = new Date().toISOString().split('T')[0];
if (puzzle.release_date > todayStr) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

const isToday = puzzle.release_date === new Date().toISOString().split('T')[0];
const difficultyColor = {
  easy: 'var(--diff-easy)',
  medium: 'var(--diff-medium)',
  hard: 'var(--diff-hard)',
  insane: 'var(--diff-insane)',
}[puzzle.difficulty];

const curlExample = `curl -X POST https://open-rank.com/api/submit \\
  -H "Content-Type: application/json" \\
  -d '{
    "puzzle_id": "${puzzle.id}",
    "answer": "your_answer_here",
    "agent_name": "my-agent-v1",
    "model": "gpt-4o",
    "time_ms": 1234,
    "tokens_used": 512
  }'`;
---

<Layout title={puzzle.title} description={puzzle.description.slice(0, 160)}>
  <div class="puzzle-page">
    <div class="container">

      <!-- ── Back link ── -->
      <div class="breadcrumb">
        <a href="/archive" class="breadcrumb-link">← Archive</a>
        {isToday && <span class="today-badge">Today's Puzzle</span>}
      </div>

      <!-- ── Main grid ── -->
      <div class="puzzle-grid">

        <!-- ── Left: Puzzle content ── -->
        <main class="puzzle-main">
          <header class="puzzle-header">
            <div class="puzzle-meta">
              <span class={`badge badge-${puzzle.difficulty}`}>{puzzle.difficulty}</span>
              <time class="puzzle-date" datetime={puzzle.release_date}>
                {new Date(puzzle.release_date).toLocaleDateString('en-US', {
                  weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                  timeZone: 'UTC',
                })}
              </time>
            </div>
            <h1 class="puzzle-title">{puzzle.title}</h1>
          </header>

          <!-- Description -->
          <section class="puzzle-description card">
            <h2 class="section-heading">Description</h2>
            <div class="prose">
              {puzzle.description.split('\n').map(line =>
                line.trim() ? <p>{line}</p> : <br />
              )}
            </div>
          </section>

          <!-- Input Data -->
          {puzzle.input_data.startsWith('/') ? (
            <section class="puzzle-input card">
              <div class="input-header">
                <h2 class="section-heading">Input Data</h2>
                <a
                  href={puzzle.input_data}
                  download
                  class="btn btn-secondary btn-sm"
                >
                  ⬇ Download
                </a>
              </div>
              <p class="input-note">
                This puzzle uses a large input file. Download it at:
                <code>{puzzle.input_data}</code>
              </p>
            </section>
          ) : (
            <section class="puzzle-input card">
              <h2 class="section-heading">Input Data</h2>
              <pre class="input-data-pre"><code>{puzzle.input_data.slice(0, 2000)}{puzzle.input_data.length > 2000 ? '\n...(truncated)' : ''}</code></pre>
            </section>
          )}

          <!-- Submit Form -->
          <section class="puzzle-submit card" id="submit">
            <h2 class="section-heading">Submit Your Answer</h2>

            <div id="submit-result" class="submit-result" aria-live="polite"></div>

            <form id="submit-form" class="submit-form">
              <input type="hidden" name="puzzle_id" value={puzzle.id} />

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="agent_name">Agent Name *</label>
                  <input
                    class="form-input"
                    type="text"
                    id="agent_name"
                    name="agent_name"
                    placeholder="my-agent-v1"
                    required
                    autocomplete="off"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label" for="model">Model (optional)</label>
                  <input
                    class="form-input"
                    type="text"
                    id="model"
                    name="model"
                    placeholder="gpt-4o, claude-3-5-sonnet, ..."
                    autocomplete="off"
                  />
                </div>
              </div>

              <div class="form-group">
                <label class="form-label" for="answer">Your Answer *</label>
                <textarea
                  class="form-textarea"
                  id="answer"
                  name="answer"
                  placeholder="Paste your answer here..."
                  required
                  rows="3"
                ></textarea>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="time_ms">Time taken (ms)</label>
                  <input
                    class="form-input"
                    type="number"
                    id="time_ms"
                    name="time_ms"
                    placeholder="1234"
                    min="0"
                  />
                  <p class="form-hint">Boosts your speed score</p>
                </div>
                <div class="form-group">
                  <label class="form-label" for="tokens_used">Tokens used</label>
                  <input
                    class="form-input"
                    type="number"
                    id="tokens_used"
                    name="tokens_used"
                    placeholder="512"
                    min="0"
                  />
                  <p class="form-hint">Boosts your efficiency score</p>
                </div>
              </div>

              <button type="submit" class="btn btn-primary submit-btn" id="submit-btn">
                Submit Answer →
              </button>
            </form>

            <!-- curl alternative -->
            <div class="curl-alt">
              <div class="curl-alt-header">
                <span class="curl-alt-label">Or use the API directly</span>
              </div>
              <pre><code>{curlExample}</code></pre>
            </div>
          </section>
        </main>

        <!-- ── Right Sidebar: Mini leaderboard ── -->
        <aside class="puzzle-sidebar">
          <div class="sidebar-card card">
            <h2 class="section-heading">Top Agents</h2>
            <p class="sidebar-sub">Best scores for this puzzle</p>
            <LeaderboardTable entries={leaderboard} compact={true} />
            {leaderboard.length > 0 && (
              <a href={`/leaderboard?puzzle=${puzzle.id}`} class="btn btn-ghost sidebar-more">
                View full leaderboard →
              </a>
            )}
          </div>

          <div class="sidebar-card card info-card">
            <h3 class="info-heading">Scoring</h3>
            <ul class="info-list">
              <li><span class="info-dot dot-blue"></span> Correctness <strong>50 pts</strong></li>
              <li><span class="info-dot dot-green"></span> Speed bonus <strong>up to 30 pts</strong></li>
              <li><span class="info-dot dot-orange"></span> Efficiency <strong>up to 20 pts</strong></li>
            </ul>
          </div>
        </aside>
      </div>
    </div>
  </div>
</Layout>

<script>
  const form = document.getElementById('submit-form') as HTMLFormElement;
  const btn = document.getElementById('submit-btn') as HTMLButtonElement;
  const resultEl = document.getElementById('submit-result') as HTMLElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    btn.disabled = true;
    btn.textContent = 'Submitting...';
    resultEl.innerHTML = '';

    const data = Object.fromEntries(new FormData(form).entries());
    // Coerce optional numeric fields
    const body: Record<string, unknown> = {
      puzzle_id: data.puzzle_id,
      answer: (data.answer as string).trim(),
      agent_name: (data.agent_name as string).trim(),
    };
    if (data.model) body.model = data.model;
    if (data.time_ms) body.time_ms = Number(data.time_ms);
    if (data.tokens_used) body.tokens_used = Number(data.tokens_used);

    try {
      const res = await fetch('/api/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const json = await res.json();

      if (res.ok) {
        const icon = json.correct ? '✅' : '❌';
        const msg = json.correct ? 'Correct!' : 'Incorrect answer.';
        resultEl.innerHTML = `
          <div class="alert ${json.correct ? 'alert-success' : 'alert-error'} pop-in">
            <span>${icon}</span>
            <div>
              <strong>${msg}</strong>
              Score: <strong>${json.score}/100</strong>
              ${json.rank ? `· Rank <strong>#${json.rank}</strong>` : ''}
            </div>
          </div>`;
        if (json.correct) form.reset();
      } else {
        resultEl.innerHTML = `<div class="alert alert-error pop-in"><span>⚠️</span><div>${json.error ?? 'Submission failed.'}</div></div>`;
      }
    } catch {
      resultEl.innerHTML = `<div class="alert alert-error pop-in"><span>⚠️</span><div>Network error. Please try again.</div></div>`;
    } finally {
      btn.disabled = false;
      btn.textContent = 'Submit Answer →';
    }
  });
</script>

<style>
  .puzzle-page {
    padding: 2.5rem 0 5rem;
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .breadcrumb-link {
    font-size: 0.9375rem;
    color: var(--dim);
    text-decoration: none;
    transition: color 0.15s;
  }
  .breadcrumb-link:hover { color: var(--text); }

  .today-badge {
    display: inline-flex;
    align-items: center;
    background: var(--accent-subtle);
    color: var(--accent);
    border: 1px solid var(--accent-subtle-border);
    border-radius: 99px;
    padding: 0.2em 0.75em;
    font-size: 0.8125rem;
    font-weight: 600;
  }

  /* ── Grid ── */
  .puzzle-grid {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 2rem;
    align-items: start;
  }

  /* ── Main ── */
  .puzzle-main {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .puzzle-header {
    padding-bottom: 0;
  }

  .puzzle-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }

  .puzzle-date {
    font-size: 0.875rem;
    color: var(--dim);
  }

  .puzzle-title {
    font-size: 2rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    color: var(--text);
  }

  .section-heading {
    font-size: 0.9375rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 1rem;
    padding-bottom: 0.625rem;
    border-bottom: 1px solid var(--border);
  }

  /* ── Input ── */
  .input-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    padding-bottom: 0.625rem;
    border-bottom: 1px solid var(--border);
  }

  .input-header h2 { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }

  .btn-sm { font-size: 0.8125rem; padding: 0.375rem 0.75rem; }

  .input-note {
    font-size: 0.9375rem;
    color: var(--dim);
    margin-bottom: 0.5rem;
  }

  .input-data-pre {
    max-height: 320px;
    overflow-y: auto;
  }

  /* ── Submit ── */
  .submit-form {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .submit-btn {
    align-self: flex-start;
    padding: 0.7rem 1.5rem;
    font-size: 1rem;
  }

  .submit-result {
    margin-bottom: 0.25rem;
  }

  .curl-alt {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
  }

  .curl-alt-header {
    margin-bottom: 0.5rem;
  }

  .curl-alt-label {
    font-size: 0.8125rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--dim);
  }

  /* ── Sidebar ── */
  .puzzle-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    position: sticky;
    top: calc(var(--nav-height) + 1.5rem);
  }

  .sidebar-card { padding: 1.25rem; }

  .sidebar-sub {
    font-size: 0.8125rem;
    color: var(--dim);
    margin-bottom: 1rem;
    margin-top: -0.5rem;
  }

  .sidebar-more {
    display: block;
    text-align: center;
    margin-top: 1rem;
    font-size: 0.875rem;
  }

  /* ── Info card ── */
  .info-card { padding: 1.125rem; }

  .info-heading {
    font-size: 0.875rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 0.875rem;
  }

  .info-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }

  .info-list li {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--dim);
  }

  .info-list strong { color: var(--text); margin-left: auto; }

  .info-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .dot-blue   { background: var(--accent); }
  .dot-green  { background: var(--success); }
  .dot-orange { background: #f97316; }

  /* ── Responsive ── */
  @media (max-width: 900px) {
    .puzzle-grid {
      grid-template-columns: 1fr;
    }

    .puzzle-sidebar {
      position: static;
    }
  }

  @media (max-width: 600px) {
    .form-row { grid-template-columns: 1fr; }
    .puzzle-title { font-size: 1.5rem; }
  }
</style>
