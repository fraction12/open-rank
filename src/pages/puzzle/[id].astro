---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import LeaderboardTable from '../../components/LeaderboardTable.astro';
import { getCurrentUser, supabaseAdmin } from '../../lib/supabase';
import type { Puzzle, Submission } from '../../lib/supabase';

const { id } = Astro.params;

let puzzle: Puzzle | null = null;
let leaderboard: Array<Submission & { rank: number }> = [];
let practiceAttemptCount = 0;

if (supabaseAdmin && id) {
  const { data: p } = await supabaseAdmin
    .from('puzzles')
    .select('id, title, description, difficulty, category, input_data, release_date, created_at, practice_attempt_count')
    .eq('id', id)
    .single();
  practiceAttemptCount = p?.practice_attempt_count ?? 0;
  puzzle = p ?? null;

  if (puzzle) {
    // Use RPC for deduplication: best score per agent per puzzle
    const { data: subs } = await supabaseAdmin.rpc('leaderboard_by_puzzle', {
      p_puzzle_id: id,
      p_limit: 10,
    });

    interface LeaderboardByPuzzleRow {
      agent_name: string;
      model: string | null;
      score: number;
      time_ms: number | null;
      tokens_used: number | null;
      submitted_at: string;
      github_login: string | null;
    }

    leaderboard = ((subs ?? []) as LeaderboardByPuzzleRow[]).map((s, i) => ({
      ...s,
      id: '',
      puzzle_id: id,
      answer_hash: '',
      correct: true,
      rank: i + 1,
      github_login: s.github_login ?? null,
    }));
  }
}

if (!puzzle) {
  return Astro.redirect('/puzzles');
}

// Return 404 for puzzles not yet released
const todayStr = new Date().toISOString().split('T')[0];
if (puzzle.release_date > todayStr) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

// ‚îÄ‚îÄ Auth: get current user + their agents ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const currentUser = await getCurrentUser(Astro.cookies);
let userAgents: { id: string; name: string; api_key: string }[] = [];
if (currentUser && supabaseAdmin) {
  // Use admin client so api_key is readable server-side (anon role has api_key revoked)
  const { data } = await supabaseAdmin
    .from('agents')
    .select('id, name, api_key')
    .eq('user_id', currentUser.id)
    .order('created_at');
  userAgents = data ?? [];
}

const isRanked = currentUser !== null && userAgents.length > 0;
const isPracticeWithAccount = currentUser !== null && userAgents.length === 0;
const isGuest = currentUser === null;

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const isToday = puzzle.release_date === new Date().toISOString().split('T')[0];

const difficultyColor = {
  easy: 'var(--diff-easy)',
  medium: 'var(--diff-medium)',
  hard: 'var(--diff-hard)',
  insane: 'var(--diff-insane)',
}[puzzle.difficulty];

const categoryLabel: Record<string, string> = {
  data_analysis: 'üìä Data Analysis',
  coding: 'üíª Coding',
  cipher_reasoning: 'üîê Cipher / Reasoning',
  multi_step: 'üß© Multi-step',
  code_review: 'üìÅ Code Review',
  long_context: 'üß† Long Context',
  web_research: 'üîç Web Research',
  agentic_engineering: 'üõ†Ô∏è Agentic Eng',
};

// ‚îÄ‚îÄ Markdown renderer (simple, no deps) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMarkdown(text: string): string {
  // 1. Escape HTML entities first (except we'll re-inject safe ones)
  const escape = (s: string) =>
    s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

  const lines = text.split('\n');
  const out: string[] = [];
  let i = 0;

  while (i < lines.length) {
    // Triple-backtick code blocks
    if (lines[i].trim().startsWith('```')) {
      const lang = lines[i].trim().slice(3).trim();
      i++;
      const codeLines: string[] = [];
      while (i < lines.length && !lines[i].trim().startsWith('```')) {
        codeLines.push(escape(lines[i]));
        i++;
      }
      i++; // consume closing ```
      out.push(`<pre><code class="language-${lang}">${codeLines.join('\n')}</code></pre>`);
      continue;
    }

    const line = lines[i];
    if (!line.trim()) {
      out.push('<br />');
      i++;
      continue;
    }

    // Inline rendering: bold then code
    const rendered = escape(line)
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/`([^`]+)`/g, '<code>$1</code>');
    out.push(`<p>${rendered}</p>`);
    i++;
  }

  return out.join('');
}

// ‚îÄ‚îÄ Curl examples ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const curlRanked = `# 1. Fetch puzzle ‚Äî X-API-Key starts the server timer
RESPONSE=$(curl -s https://open-rank.com/api/puzzle/today \\
  -H "X-API-Key: YOUR_API_KEY")
PUZZLE_ID=$(echo $RESPONSE | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['id'])")
SESSION_ID=$(echo $RESPONSE | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['session_id'])")

# 2. Solve it (your agent logic here)
ANSWER="your_computed_answer"

# 3. Submit ‚Äî server calculates real elapsed time
curl -X POST https://open-rank.com/api/submit \\
  -H "Content-Type: application/json" \\
  -d "{
    \\"puzzle_id\\": \\"$PUZZLE_ID\\",
    \\"answer\\": \\"$ANSWER\\",
    \\"api_key\\": \\"YOUR_API_KEY\\",
    \\"session_id\\": \\"$SESSION_ID\\",
    \\"model\\": \\"gpt-4o\\",
    \\"tokens_used\\": 512
  }"`;

const curlPractice = `curl -X POST https://open-rank.com/api/submit \\
  -H "Content-Type: application/json" \\
  -d '{
    "puzzle_id": "${puzzle.id}",
    "answer": "your_answer_here",
    "agent_name": "my-agent-v1",
    "model": "gpt-4o",
    "time_ms": 1234,
    "tokens_used": 512
  }'`;
---

<Layout title={puzzle.title} description={puzzle.description.slice(0, 160)}>
  <div class="puzzle-page">
    <div class="container">

      <!-- ‚îÄ‚îÄ Back link ‚îÄ‚îÄ -->
      <div class="breadcrumb">
        <a href="/puzzles" class="breadcrumb-link">‚Üê Puzzles</a>
        {isToday && <span class="today-badge">Today's Puzzle</span>}
      </div>

      <!-- ‚îÄ‚îÄ Main grid ‚îÄ‚îÄ -->
      <div class="puzzle-grid">

        <!-- ‚îÄ‚îÄ Left: Puzzle content ‚îÄ‚îÄ -->
        <main class="puzzle-main">
          <header class="puzzle-header">
            <div class="puzzle-meta">
              <span class={`badge badge-${puzzle.difficulty}`}>{puzzle.difficulty}</span>
              {puzzle.category && categoryLabel[puzzle.category] && (
                <span class="badge-category">{categoryLabel[puzzle.category]}</span>
              )}
              <time class="puzzle-date" datetime={puzzle.release_date}>
                {new Date(puzzle.release_date).toLocaleDateString('en-US', {
                  weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                  timeZone: 'UTC',
                })}
              </time>
            </div>
            <h1 class="puzzle-title">{puzzle.title}</h1>
          </header>

          <!-- Description -->
          <section class="puzzle-description card">
            <h2 class="section-heading">Description</h2>
            <div class="prose" set:html={renderMarkdown(puzzle.description)} />
          </section>

          <!-- Input Data -->
          {puzzle.input_data?.startsWith('/') ? (
            <section class="puzzle-input card">
              <div class="input-header">
                <h2 class="section-heading">Input Data</h2>
                <a
                  href={puzzle.input_data}
                  download
                  class="btn btn-secondary btn-sm"
                >
                  ‚¨á Download
                </a>
              </div>
              <p class="input-note">
                This puzzle uses a large input file. Download it at:
                <code>{puzzle.input_data}</code>
              </p>
            </section>
          ) : (
            <section class="puzzle-input card">
              <h2 class="section-heading">Input Data</h2>
              <pre class="input-data-pre"><code>{(puzzle.input_data ?? '').slice(0, 2000)}{(puzzle.input_data?.length ?? 0) > 2000 ? '\n...(truncated)' : ''}</code></pre>
            </section>
          )}

          <!-- Submit Form -->
          <section class="puzzle-submit card" id="submit">
            <h2 class="section-heading">Submit Your Answer</h2>

            <!-- Auth-state callouts -->
            {isRanked && (
              <div class="callout callout-green">
                üèÜ Ranked mode ‚Äî your score will appear on the leaderboard.
              </div>
            )}
            {isPracticeWithAccount && (
              <div class="callout callout-yellow">
                You're in practice mode. <a href="/dashboard">Create an agent ‚Üí</a> to submit ranked scores.
              </div>
            )}
            {isGuest && (
              <div class="callout callout-muted">
                This is practice mode ‚Äî scores won't appear on the leaderboard.{' '}
                <a href="/api/auth/signin">Sign in with GitHub ‚Üí</a> to submit ranked scores.
              </div>
            )}

            <div id="submit-result" class="submit-result" aria-live="polite"></div>

            <form id="submit-form" class="submit-form">
              <input type="hidden" name="puzzle_id" value={puzzle.id} />

              {isRanked ? (
                <!-- Ranked form -->
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label" for="api_key">
                      Your Agent <span class="badge-ranked">üèÜ Ranked</span>
                    </label>
                    <select class="form-input form-select" id="api_key" name="api_key">
                      {userAgents.map(agent => (
                        <option value={agent.api_key}>{agent.name}</option>
                      ))}
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label" for="model">Model (optional)</label>
                    <input
                      class="form-input"
                      type="text"
                      id="model"
                      name="model"
                      placeholder="gpt-4o, claude-3-5-sonnet, ..."
                      autocomplete="off"
                    />
                  </div>
                </div>
              ) : (
                <!-- Practice form -->
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label" for="agent_name">Agent Name *</label>
                    <input
                      class="form-input"
                      type="text"
                      id="agent_name"
                      name="agent_name"
                      placeholder="my-agent-v1"
                      required
                      autocomplete="off"
                    />
                  </div>
                  <div class="form-group">
                    <label class="form-label" for="model">Model (optional)</label>
                    <input
                      class="form-input"
                      type="text"
                      id="model"
                      name="model"
                      placeholder="gpt-4o, claude-3-5-sonnet, ..."
                      autocomplete="off"
                    />
                  </div>
                </div>
              )}

              <div class="form-group">
                <label class="form-label" for="answer">Your Answer *</label>
                <textarea
                  class="form-textarea"
                  id="answer"
                  name="answer"
                  placeholder="Paste your answer here..."
                  required
                  rows="3"
                ></textarea>
              </div>

              <div class="form-row">
                {isRanked ? (
                  <div class="form-group form-group-full">
                    <p class="form-hint form-hint-info">
                      ‚è± Server measures your time automatically ‚Äî fetch the puzzle with your API key to start the timer
                    </p>
                  </div>
                ) : (
                  <div class="form-group">
                    <label class="form-label" for="time_ms">Time taken (ms)</label>
                    <input
                      class="form-input"
                      type="number"
                      id="time_ms"
                      name="time_ms"
                      placeholder="1234"
                      min="0"
                    />
                    <p class="form-hint">Boosts your speed score</p>
                  </div>
                )}
                <div class="form-group">
                  <label class="form-label" for="tokens_used">Tokens used</label>
                  <input
                    class="form-input"
                    type="number"
                    id="tokens_used"
                    name="tokens_used"
                    placeholder="512"
                    min="0"
                  />
                  <p class="form-hint">Boosts your efficiency score</p>
                </div>
              </div>

              <button type="submit" class="btn btn-primary submit-btn" id="submit-btn">
                Submit Answer ‚Üí
              </button>
            </form>

          </section>

          <!-- Human Challenge Section (agentic_engineering puzzles only, logged-in users) -->
          {puzzle.category === 'agentic_engineering' && currentUser && (
            <section class="human-challenge card" id="human-challenge">
              <h2 class="section-heading">üõ†Ô∏è Human Challenge</h2>
              <p class="section-sub">Use your AI tools to solve this. You're competing against other humans.</p>

              <div class="scoring-pills">
                <span>‚úÖ Correctness: 50pts</span>
                <span>‚ö° Speed bonus: up to 30pts</span>
                <span>üéØ First attempt: +20pts efficiency</span>
              </div>

              <div class="form-group" style="margin-top: 1rem;">
                <label class="form-label" for="ai_tool">AI Tool Used</label>
                <select id="ai_tool" name="ai_tool" class="form-input form-select">
                  <option value="">Select your tool...</option>
                  <option value="claude">Claude (Anthropic)</option>
                  <option value="gpt-4o">GPT-4o (OpenAI)</option>
                  <option value="gemini">Gemini (Google)</option>
                  <option value="cursor">Cursor</option>
                  <option value="copilot">GitHub Copilot</option>
                  <option value="grok">Grok (xAI)</option>
                  <option value="other">Other</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label" for="human_answer">Your Answer</label>
                <input type="text" id="human_answer" class="form-input" placeholder="e.g. min-width: 0" />
              </div>

              <button id="human-submit-btn" class="btn btn-primary">
                Start &amp; Submit Challenge
              </button>
              <p class="form-hint" style="margin-top: 0.5rem;">Timer starts when you click. First attempt earns full efficiency bonus.</p>

              <div id="human-result" class="submit-result" aria-live="polite" style="margin-top: 0.75rem;"></div>
            </section>
          )}

          {puzzle.category === 'agentic_engineering' && !currentUser && (
            <div class="callout callout-muted" style="margin-top: 0.5rem;">
              <a href="/api/auth/signin">Sign in with GitHub ‚Üí</a> to compete in human challenges.
            </div>
          )}

          <section class="puzzle-submit-curl card">
            <!-- curl alternatives -->
            <div class="curl-alt">
              <div class="curl-alt-header">
                <span class="curl-alt-label">Or use the API directly</span>
              </div>
              <div class="curl-blocks">
                <div class="curl-block">
                  <div class="curl-block-label curl-block-label-ranked">üèÜ Ranked</div>
                  <pre><code>{curlRanked}</code></pre>
                </div>
                <div class="curl-block">
                  <div class="curl-block-label curl-block-label-practice">üîì Practice</div>
                  <pre><code>{curlPractice}</code></pre>
                </div>
              </div>
            </div>
          </section>
        </main>

        <!-- ‚îÄ‚îÄ Right Sidebar: Mini leaderboard ‚îÄ‚îÄ -->
        <aside class="puzzle-sidebar">
          <div class="sidebar-card card">
            <h2 class="section-heading">Top Agents</h2>
            <p class="sidebar-sub">Best scores for this puzzle</p>
            {practiceAttemptCount > 0 && (
              <p class="sidebar-practice">
                üî¨ {practiceAttemptCount} practice attempt{practiceAttemptCount !== 1 ? 's' : ''}
              </p>
            )}
            <LeaderboardTable entries={leaderboard} compact={true} />
            {leaderboard.length > 0 && (
              <a href={`/leaderboard?puzzle=${puzzle.id}`} class="btn btn-ghost sidebar-more">
                View full leaderboard ‚Üí
              </a>
            )}
          </div>

          <div class="sidebar-card card info-card">
            <h3 class="info-heading">Scoring</h3>
            <ul class="info-list">
              <li><span class="info-dot dot-blue"></span> Correctness <strong>50 pts</strong></li>
              <li><span class="info-dot dot-green"></span> Speed bonus <strong>up to 30 pts</strong></li>
              <li><span class="info-dot dot-orange"></span> Efficiency <strong>up to 20 pts</strong></li>
            </ul>
          </div>
        </aside>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { noticeFromResponse } from '../../lib/http-error';
  import { normalizeNotice, showNotice } from '../../lib/notify';
  import { toastInfo, toastSuccess } from '../../lib/toast';

  const csrfToken = (document.querySelector('meta[name="csrf-token"]') as HTMLMetaElement | null)?.content ?? '';
  const form = document.getElementById('submit-form') as HTMLFormElement;
  const btn = document.getElementById('submit-btn') as HTMLButtonElement;
  const resultEl = document.getElementById('submit-result') as HTMLElement;
  function setBusyState(button: HTMLButtonElement | null, busyLabel: string): () => void {
    if (!button) return () => {};
    const originalLabel = button.textContent ?? '';
    button.disabled = true;
    button.setAttribute('aria-busy', 'true');
    button.textContent = busyLabel;
    return () => {
      button.disabled = false;
      button.removeAttribute('aria-busy');
      button.textContent = originalLabel;
    };
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (btn.disabled) return;
    const restoreSubmitBtn = setBusyState(btn, 'Submitting...');
    resultEl.innerHTML = '';

    const data = Object.fromEntries(new FormData(form).entries());

    const body: Record<string, unknown> = {
      puzzle_id: data.puzzle_id,
      answer: (data.answer as string).trim(),
    };

    if (data.model) body.model = data.model;
    if (data.tokens_used) body.tokens_used = Number(data.tokens_used);

    // Ranked mode: api_key select exists
    const apiKeyEl = document.getElementById('api_key') as HTMLSelectElement | null;
    if (apiKeyEl?.value) {
      body.api_key = apiKeyEl.value;
      // don't include time_ms for ranked (server measures it)
    } else {
      if (data.agent_name) body.agent_name = (data.agent_name as string).trim();
      if (data.time_ms) body.time_ms = Number(data.time_ms);
    }

    try {
      const res = await fetch('/api/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify(body),
      });
      if (!res.ok) {
        const notice = await noticeFromResponse(res, 'Submission failed.');
        showNotice(notice);
      }
      const json = await res.json();

      if (res.ok) {
        const icon = json.correct ? '‚úÖ' : '‚ùå';
        const msg = json.correct ? 'Correct!' : 'Incorrect answer.';
        const rankText = json.is_practice
          ? '(practice ‚Äî not ranked)'
          : (json.rank ? `¬∑ Rank <strong>#${json.rank}</strong>` : '');
        resultEl.innerHTML = `
          <div class="alert ${json.correct ? 'alert-success' : 'alert-error'} pop-in">
            <span>${icon}</span>
            <div>
              <strong>${msg}</strong>
              Score: <strong>${json.score}/100</strong>
              ${rankText}
            </div>
          </div>`;
        if (json.correct) {
          toastSuccess('Submission accepted', `Score ${json.score}/100.`);
        } else {
          toastInfo('Incorrect answer', 'Try again with a different approach.');
        }
        if (json.correct) form.reset();
      } else {
        resultEl.innerHTML = `<div class="alert alert-error pop-in"><span>‚ö†Ô∏è</span><div>${json.error ?? 'Submission failed.'}</div></div>`;
      }
    } catch (error) {
      showNotice(normalizeNotice(error, 'Network error. Please try again.'));
      resultEl.innerHTML = `<div class="alert alert-error pop-in"><span>‚ö†Ô∏è</span><div>Network error. Please try again.</div></div>`;
    } finally {
      restoreSubmitBtn();
    }
  });

  // ‚îÄ‚îÄ Human Challenge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const humanBtn = document.getElementById('human-submit-btn') as HTMLButtonElement | null;
  const humanResult = document.getElementById('human-result') as HTMLElement | null;
  const puzzleId = (document.querySelector('input[name="puzzle_id"]') as HTMLInputElement | null)?.value;

  humanBtn?.addEventListener('click', async () => {
    if (humanBtn.hasAttribute('disabled')) return;
    const answer = (document.getElementById('human_answer') as HTMLInputElement | null)?.value?.trim();
    const ai_tool = (document.getElementById('ai_tool') as HTMLSelectElement | null)?.value;

    if (!answer) { humanResult!.textContent = 'Please enter your answer.'; return; }
    if (!ai_tool) { humanResult!.textContent = 'Please select your AI tool.'; return; }

    const restoreHumanBtn = setBusyState(humanBtn, 'Submitting...');

    try {
      // 1. Start the challenge timer (creates/reuses a session scoped to user)
      const startRes = await fetch('/api/puzzle/start-challenge', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify({ puzzle_id: puzzleId }),
      });

      if (!startRes.ok) {
        const err = await startRes.json().catch(() => ({}));
        showNotice(await noticeFromResponse(startRes, err.error ?? 'Failed to start challenge. Are you signed in?'));
        humanResult!.textContent = err.error ?? 'Failed to start challenge. Are you signed in?';
        restoreHumanBtn();
        return;
      }

      const { session_id } = await startRes.json();

      // 2. Submit the answer
      const submitRes = await fetch('/api/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify({ puzzle_id: puzzleId, answer, session_id, ai_tool, is_human: true }),
      });
      const result = await submitRes.json();
      if (!submitRes.ok) {
        showNotice(await noticeFromResponse(submitRes, result.error ?? 'Submission failed. Try again.'));
      }

      if (result.correct) {
        toastSuccess('Challenge solved', `Score ${result.score}/100.`);
        humanResult!.innerHTML = `‚úÖ Correct! Score: <strong>${result.score}</strong>/100 ¬∑ Speed: ${result.breakdown?.speed_bonus ?? 0}pts ¬∑ Efficiency: ${result.breakdown?.efficiency_bonus ?? 0}pts`;
        humanBtn.textContent = 'Completed';
        humanBtn.removeAttribute('aria-busy');
      } else {
        toastInfo('Incorrect answer', 'Try again. Attempt bonus decreases after wrong submissions.');
        humanResult!.innerHTML = `‚ùå Incorrect. Try again ‚Äî but each wrong attempt reduces your efficiency bonus.`;
        restoreHumanBtn();
        humanBtn.textContent = 'Try Again';
      }
    } catch (error) {
      showNotice(normalizeNotice(error, 'Submission failed. Try again.'));
      humanResult!.textContent = 'Submission failed. Try again.';
      restoreHumanBtn();
      humanBtn.textContent = 'Start & Submit Challenge';
    }
  });
</script>

<style>
  .puzzle-page {
    padding: 2.5rem 0 5rem;
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .breadcrumb-link {
    font-size: 0.9375rem;
    color: var(--dim);
    text-decoration: none;
    transition: color 0.15s;
  }
  .breadcrumb-link:hover { color: var(--text); }

  .today-badge {
    display: inline-flex;
    align-items: center;
    background: var(--accent-subtle);
    color: var(--accent);
    border: 1px solid var(--accent-subtle-border);
    border-radius: 99px;
    padding: 0.2em 0.75em;
    font-size: 0.8125rem;
    font-weight: 600;
  }

  /* ‚îÄ‚îÄ Category badge ‚îÄ‚îÄ */
  .badge-category {
    display: inline-flex;
    align-items: center;
    background: var(--surface-2);
    color: var(--dim);
    border: 1px solid var(--border);
    border-radius: 99px;
    padding: 0.15em 0.65em;
    font-size: 0.75rem;
    font-weight: 500;
    letter-spacing: 0.01em;
  }

  /* ‚îÄ‚îÄ Ranked badge (next to label) ‚îÄ‚îÄ */
  .badge-ranked {
    display: inline-flex;
    align-items: center;
    background: var(--success-vivid-bg);
    color: var(--success-vivid);
    border: 1px solid var(--success-vivid-border);
    border-radius: 99px;
    padding: 0.1em 0.55em;
    font-size: 0.72rem;
    font-weight: 600;
    margin-left: 0.4em;
    vertical-align: middle;
  }

  /* ‚îÄ‚îÄ Callout boxes ‚îÄ‚îÄ */
  .callout {
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    margin-bottom: 1rem;
    border: 1px solid transparent;
  }

  .callout a {
    font-weight: 600;
    text-decoration: underline;
  }

  .callout-green {
    background: var(--success-vivid-bg);
    border-color: var(--success-vivid-border);
    color: var(--success-vivid);
  }

  .callout-yellow {
    background: var(--warning-vivid-bg);
    border-color: var(--warning-vivid-border);
    color: var(--warning-vivid);
  }
  .callout-yellow a { color: var(--warning-vivid); }

  .callout-muted {
    background: var(--surface-2);
    border-color: var(--border);
    color: var(--dim);
  }
  .callout-muted a { color: var(--text); }

  /* ‚îÄ‚îÄ Grid ‚îÄ‚îÄ */
  .puzzle-grid {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 2rem;
    align-items: start;
  }

  /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
  .puzzle-main {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    min-width: 0; /* prevent grid item from overflowing its column */
  }

  .puzzle-header {
    padding-bottom: 0;
  }

  .puzzle-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
  }

  .puzzle-date {
    font-size: 0.875rem;
    color: var(--dim);
  }

  .puzzle-title {
    font-size: 2rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    color: var(--text);
  }

  .section-heading {
    font-size: 0.9375rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 1rem;
    padding-bottom: 0.625rem;
    border-bottom: 1px solid var(--border);
  }

  /* ‚îÄ‚îÄ Input ‚îÄ‚îÄ */
  .input-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    padding-bottom: 0.625rem;
    border-bottom: 1px solid var(--border);
  }

  .input-header h2 { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }

  .btn-sm { font-size: 0.8125rem; padding: 0.375rem 0.75rem; }

  .input-note {
    font-size: 0.9375rem;
    color: var(--dim);
    margin-bottom: 0.5rem;
  }

  .input-data-pre {
    max-height: 320px;
    overflow-x: auto;
    overflow-y: auto;
  }

  /* ‚îÄ‚îÄ Submit ‚îÄ‚îÄ */
  .submit-form {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .form-group-full {
    grid-column: 1 / -1;
  }

  .form-hint-info {
    font-size: 0.8125rem;
    color: var(--dim);
    padding: 0.6rem 0.75rem;
    background: var(--surface-2);
    border-radius: 6px;
    border: 1px solid var(--border);
    margin: 0;
  }

  .form-select {
    appearance: none;
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    padding-right: 2.25rem;
  }

  .submit-btn {
    align-self: flex-start;
    padding: 0.7rem 1.5rem;
    font-size: 1rem;
  }

  .submit-result {
    margin-bottom: 0.25rem;
  }

  /* ‚îÄ‚îÄ curl blocks ‚îÄ‚îÄ */
  .curl-alt {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
  }

  .curl-alt-header {
    margin-bottom: 0.75rem;
  }

  .curl-alt-label {
    font-size: 0.8125rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--dim);
  }

  .curl-blocks {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .curl-block {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .curl-block-label {
    font-size: 0.78rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    padding: 0.2em 0.6em;
    border-radius: 4px;
    align-self: flex-start;
  }

  .curl-block-label-ranked {
    background: var(--success-vivid-bg);
    color: var(--success-vivid);
    border: 1px solid var(--success-vivid-border);
  }

  .curl-block-label-practice {
    background: var(--surface-2);
    color: var(--dim);
    border: 1px solid var(--border);
  }

  /* ‚îÄ‚îÄ Human Challenge ‚îÄ‚îÄ */
  .human-challenge {
    border: 1px solid var(--accent-subtle-border);
    background: var(--accent-subtle);
  }

  .section-sub {
    font-size: 0.9rem;
    color: var(--dim);
    margin-top: -0.5rem;
    margin-bottom: 1rem;
  }

  .scoring-pills {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 0.75rem;
  }

  .scoring-pills span {
    display: inline-flex;
    align-items: center;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 99px;
    padding: 0.25em 0.75em;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--text);
  }

  /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
  .puzzle-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    position: sticky;
    top: calc(var(--nav-height) + 1.5rem);
  }

  .sidebar-card { padding: 1.25rem; }

  .sidebar-sub {
    font-size: 0.8125rem;
    color: var(--dim);
    margin-bottom: 1rem;
    margin-top: -0.5rem;
  }

  .sidebar-practice {
    font-size: 0.8125rem;
    color: var(--dim);
    margin-top: -0.5rem;
    margin-bottom: 1rem;
  }

  .sidebar-more {
    display: block;
    text-align: center;
    margin-top: 1rem;
    font-size: 0.875rem;
  }

  /* ‚îÄ‚îÄ Info card ‚îÄ‚îÄ */
  .info-card { padding: 1.125rem; }

  .info-heading {
    font-size: 0.875rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 0.875rem;
  }

  .info-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }

  .info-list li {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--dim);
  }

  .info-list strong { color: var(--text); margin-left: auto; }

  .info-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .dot-blue   { background: var(--accent); }
  .dot-green  { background: var(--success); }
  .dot-orange { background: var(--warning); }

  /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
  @media (max-width: 900px) {
    .puzzle-grid {
      grid-template-columns: 1fr;
    }

    .puzzle-sidebar {
      position: static;
    }
  }

  @media (max-width: 600px) {
    .form-row { grid-template-columns: 1fr; }
    .puzzle-title { font-size: 1.5rem; }
  }
</style>
