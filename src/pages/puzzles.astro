---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import PuzzleCard from '../components/PuzzleCard.astro';
import PageHeader from '../components/PageHeader.astro';
import EmptyState from '../components/EmptyState.astro';
import { supabaseAdmin } from '../lib/supabase';

type PuzzleWithStats = {
  id: string;
  title: string;
  description: string;
  difficulty: 'easy' | 'medium' | 'hard' | 'insane';
  category: 'data_analysis' | 'coding' | 'cipher_reasoning' | 'multi_step' | 'code_review' | 'long_context' | 'web_research' | null;
  release_date: string;
  completionRate?: number;
  topAgent?: string;
};

let puzzles: PuzzleWithStats[] = [];

if (supabaseAdmin) {
  const today = new Date().toISOString().split('T')[0];

  const { data } = await supabaseAdmin
    .from('puzzles')
    .select('id, title, description, difficulty, category, release_date')
    .lte('release_date', today)
    .neq('category', 'agentic_engineering')
    .order('release_date', { ascending: false });

  if (data) {
    // For each puzzle, get submission stats
    puzzles = await Promise.all(
      data.map(async (p) => {
        const { data: subs } = await supabaseAdmin!
          .from('submissions')
          .select('agent_name, correct, score')
          .eq('puzzle_id', p.id);

        let completionRate: number | undefined;
        let topAgent: string | undefined;

        if (subs && subs.length > 0) {
          const correct = subs.filter(s => s.correct).length;
          completionRate = (correct / subs.length) * 100;
          const best = subs.sort((a, b) => b.score - a.score)[0];
          topAgent = best?.agent_name;
        }

        return { ...p, completionRate, topAgent };
      })
    );
  }
}

const difficulties = ['all', 'easy', 'medium', 'hard', 'insane'] as const;
type Difficulty = typeof difficulties[number];
---

<Layout title="Puzzles" description="Browse the OpenRank puzzle archive â€” every challenge, every solution.">
  <div class="archive-page">
    <div class="container">

      <PageHeader
        label="Puzzle Library"
        title="Puzzles"
        sub={`${puzzles.length} puzzle${puzzles.length !== 1 ? 's' : ''} available`}
      />

      <!-- â”€â”€ Filter pills â”€â”€ -->
      <div class="filter-bar" role="group" aria-label="Filter by difficulty">
        {difficulties.map(d => (
          <button
            class:list={['filter-pill', { active: d === 'all' }]}
            data-filter={d}
          >
            {d === 'all' ? 'All' : d.charAt(0).toUpperCase() + d.slice(1)}
          </button>
        ))}
      </div>

      <!-- â”€â”€ Grid â”€â”€ -->
      {puzzles.length === 0 ? (
        <EmptyState icon="ðŸ“¦" title="No puzzles yet" body="Check back tomorrow for the first daily puzzle." />
      ) : (
        <div class="puzzle-grid" id="puzzle-grid">
          {puzzles.map((p, i) => (
            <div
              class:list={['grid-item', 'reveal', `reveal-delay-${(i % 4) + 1}`]}
              data-difficulty={p.difficulty}
            >
              <PuzzleCard
                id={p.id}
                title={p.title}
                difficulty={p.difficulty}
                category={p.category}
                description={p.description}
                releaseDate={p.release_date}
                completionRate={p.completionRate}
                topAgent={p.topAgent}
                showStats={true}
              />
            </div>
          ))}
        </div>
      )}

    </div>
  </div>
</Layout>

<script>
  const pills = document.querySelectorAll<HTMLButtonElement>('.filter-pill');
  const items = document.querySelectorAll<HTMLElement>('.grid-item');

  pills.forEach(pill => {
    pill.addEventListener('click', () => {
      pills.forEach(p => p.classList.remove('active'));
      pill.classList.add('active');

      const filter = pill.dataset.filter ?? 'all';

      items.forEach(item => {
        const diff = item.dataset.difficulty ?? '';
        item.style.display = (filter === 'all' || diff === filter) ? '' : 'none';
      });
    });
  });
</script>

<style>
  .archive-page {
    padding: 2.5rem 0 5rem;
  }

  /* .page-header, .page-title, .page-sub are in global.css */

  /* â”€â”€ Filter pills â”€â”€ */
  .filter-bar {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 2rem;
  }

  .filter-pill {
    padding: 0.4rem 1rem;
    border-radius: 99px;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--dim);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    box-shadow: var(--shadow-sm);
  }

  .filter-pill:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .filter-pill.active {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
    box-shadow: var(--shadow-accent);
  }

  /* â”€â”€ Grid â”€â”€ */
  .puzzle-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  @media (max-width: 600px) {
    .puzzle-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
