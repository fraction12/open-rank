---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import PuzzleCard from '../components/PuzzleCard.astro';
import PageHeader from '../components/PageHeader.astro';
import EmptyState from '../components/EmptyState.astro';
import { supabaseAdmin } from '../lib/supabase';

type PuzzleWithStats = {
  id: string;
  title: string;
  description: string;
  difficulty: 'easy' | 'medium' | 'hard' | 'insane';
  category: 'agentic_engineering';
  release_date: string;
  completionRate?: number;
  topAgent?: string;
};

let challenges: PuzzleWithStats[] = [];

if (supabaseAdmin) {
  // M2 fix: single RPC replaces N+1 queries
  const { data } = await supabaseAdmin.rpc('challenges_with_stats', { p_limit: 100 });

  if (data) {
    challenges = (data as {
      id: string;
      title: string;
      description: string;
      difficulty: 'easy' | 'medium' | 'hard' | 'insane';
      category: 'agentic_engineering';
      release_date: string;
      total_attempts: number;
      unique_solvers: number;
      best_time_ms: number | null;
    }[]).map((p) => {
      const completionRate = p.total_attempts > 0
        ? (p.unique_solvers / p.total_attempts) * 100
        : undefined;
      return {
        id: p.id,
        title: p.title,
        description: p.description,
        difficulty: p.difficulty,
        category: p.category,
        release_date: p.release_date,
        completionRate,
        topAgent: undefined,
      } as PuzzleWithStats;
    });
  }
}
---

<Layout title="Challenges" description="OpenRank Challenges ‚Äî Real engineering problems. Use your AI tools. Compete against other humans.">
  <div class="challenges-page">
    <div class="container">

      <!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ -->
      <PageHeader
        label="Challenges"
        title="Test Your AI Skills"
        sub="Real engineering problems. Your AI tools. Compete against humans."
      />

      <!-- ‚îÄ‚îÄ How It Works ‚îÄ‚îÄ -->
      <section class="how-it-works" aria-label="How it works">
        <div class="how-cards">
          <div class="how-card card">
            <span class="how-icon">üß©</span>
            <h3 class="how-title">Pick a Challenge</h3>
            <p class="how-desc">Real problems drawn from production. CSS bugs, logic errors, system design.</p>
          </div>
          <div class="how-card card">
            <span class="how-icon">ü§ñ</span>
            <h3 class="how-title">Use Your AI Tools</h3>
            <p class="how-desc">Claude, GPT-4o, Gemini, Cursor ‚Äî whatever you prefer. No restrictions.</p>
          </div>
          <div class="how-card card">
            <span class="how-icon">üèÜ</span>
            <h3 class="how-title">Submit &amp; Rank</h3>
            <p class="how-desc">Paste your answer, declare your tool, earn points for correctness + speed + first-try.</p>
          </div>
        </div>

        <div class="scoring-bar">
          <span class="scoring-item">‚úÖ Correctness: <strong>50pts</strong></span>
          <span class="scoring-sep">¬∑</span>
          <span class="scoring-item">‚ö° Speed: <strong>up to 30pts</strong></span>
          <span class="scoring-sep">¬∑</span>
          <span class="scoring-item">üß† Human rubric: <strong>up to 20pts</strong></span>
        </div>
      </section>

      <!-- ‚îÄ‚îÄ Challenges Grid ‚îÄ‚îÄ -->
      <section class="challenges-section" aria-label="Available challenges">
        <div class="section-header">
          <h2 class="section-title">Available Challenges</h2>
          <span class="challenge-count">{challenges.length} challenge{challenges.length !== 1 ? 's' : ''}</span>
        </div>

        {challenges.length === 0 ? (
          <EmptyState icon="üõ†Ô∏è" title="No challenges yet" body="Agentic engineering challenges are coming soon. Check back shortly." />
        ) : (
          <>
            <div class="challenge-controls">
              <div class="search-wrap">
                <input
                  id="challenge-search"
                  class="search-input"
                  type="search"
                  placeholder="Search challenges..."
                  aria-label="Search challenges"
                  autocomplete="off"
                />
              </div>
              <div class="difficulty-pills" role="group" aria-label="Filter challenges by difficulty">
                <button type="button" class="difficulty-pill is-active" data-difficulty="all">All</button>
                <button type="button" class="difficulty-pill" data-difficulty="medium">Medium</button>
                <button type="button" class="difficulty-pill" data-difficulty="hard">Hard</button>
                <button type="button" class="difficulty-pill" data-difficulty="insane">Insane</button>
              </div>
            </div>

            <div class="challenge-grid" id="challenge-grid">
              {challenges.map((c, i) => (
                <div
                  class:list={['grid-item', 'reveal', `reveal-delay-${(i % 4) + 1}`]}
                  data-title={c.title.toLowerCase()}
                  data-description={c.description.toLowerCase()}
                  data-difficulty={c.difficulty}
                >
                  <PuzzleCard
                    id={c.id}
                    title={c.title}
                    difficulty={c.difficulty}
                    category={c.category}
                    description={c.description}
                    releaseDate={c.release_date}
                    completionRate={c.completionRate}
                    topAgent={c.topAgent}
                    showStats={true}
                    linkBase="/challenges"
                  />
                </div>
              ))}
            </div>
            <div id="challenge-no-results" class="search-empty" style="display: none;">
              <EmptyState icon="üîé" title="No results" body="Try a different search term or clear the input." />
            </div>
          </>
        )}
      </section>

      <!-- ‚îÄ‚îÄ CTA: Human Leaderboard ‚îÄ‚îÄ -->
      <section class="leaderboard-cta card">
        <div class="cta-content">
          <span class="cta-icon">üë§</span>
          <div>
            <h3 class="cta-title">See the Human Leaderboard</h3>
            <p class="cta-desc">How do your AI tool skills compare to everyone else?</p>
          </div>
        </div>
        <a href="/leaderboard#humans" class="btn btn-primary">View Rankings ‚Üí</a>
      </section>

    </div>
  </div>
</Layout>

<script>
  const searchInput = document.querySelector<HTMLInputElement>('#challenge-search');
  const items = document.querySelectorAll<HTMLElement>('.challenge-grid .grid-item');
  const difficultyPills = document.querySelectorAll<HTMLButtonElement>('.difficulty-pill');
  const noResults = document.querySelector<HTMLElement>('#challenge-no-results');
  let activeDifficulty = 'all';

  const applyFilters = () => {
    const query = (searchInput?.value ?? '').trim().toLowerCase();
    let visibleCount = 0;

    items.forEach(item => {
      const title = item.dataset.title ?? '';
      const description = item.dataset.description ?? '';
      const difficulty = item.dataset.difficulty ?? '';
      const matchesSearch = query === '' || title.includes(query) || description.includes(query);
      const matchesDifficulty = activeDifficulty === 'all' || difficulty === activeDifficulty;
      const isVisible = matchesSearch && matchesDifficulty;

      item.style.display = isVisible ? '' : 'none';
      if (isVisible) visibleCount += 1;
    });

    if (noResults) {
      noResults.style.display = visibleCount === 0 && items.length > 0 ? '' : 'none';
    }
  };

  difficultyPills.forEach(pill => {
    pill.addEventListener('click', () => {
      activeDifficulty = pill.dataset.difficulty ?? 'all';
      difficultyPills.forEach(node => node.classList.toggle('is-active', node === pill));
      applyFilters();
    });
  });

  searchInput?.addEventListener('input', applyFilters);
  applyFilters();
</script>

<style>
  .challenges-page {
    padding: 2.5rem 0 5rem;
  }

  /* .page-header, .page-title, .page-sub are in global.css */

  .challenge-controls {
    margin-bottom: 1.25rem;
  }

  .search-wrap {
    margin-bottom: 0.75rem;
  }

  .search-input {
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg);
    color: var(--text);
    padding: 0.5rem 0.75rem;
    font-size: 0.9375rem;
    width: 100%;
    max-width: 400px;
  }

  .search-input:focus {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  .difficulty-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .difficulty-pill {
    appearance: none;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--dim);
    font-family: inherit;
    font-size: 0.8125rem;
    line-height: 1.2;
    padding: 0.3rem 0.75rem;
    border-radius: 99px;
    cursor: pointer;
  }

  .difficulty-pill:hover {
    border-color: var(--border-strong);
    color: var(--text);
  }

  .difficulty-pill.is-active {
    background: var(--accent);
    color: var(--bg);
    border-color: var(--accent);
  }

  .search-empty {
    margin-top: 1rem;
  }

  /* ‚îÄ‚îÄ How It Works ‚îÄ‚îÄ */
  .how-it-works {
    margin-bottom: 3rem;
  }

  .how-cards {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.25rem;
    margin-bottom: 1.25rem;
  }

  .how-card {
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
    padding: 1.5rem;
    text-align: center;
    align-items: center;
  }

  .how-icon {
    font-size: 2rem;
    line-height: 1;
  }

  .how-title {
    font-size: 1rem;
    font-weight: 700;
    color: var(--text);
    margin: 0;
  }

  .how-desc {
    font-size: 0.9rem;
    color: var(--dim);
    line-height: 1.6;
    margin: 0;
  }

  .scoring-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    flex-wrap: wrap;
    background: var(--surface, #f8f9fa);
    border: 1px solid var(--border);
    border-radius: var(--radius, 10px);
    padding: 0.875rem 1.5rem;
    font-size: 0.9375rem;
    color: var(--dim);
  }

  .scoring-item strong {
    color: var(--text);
    font-weight: 700;
  }

  .scoring-sep {
    color: var(--border);
    font-size: 1.25rem;
    line-height: 1;
  }

  /* ‚îÄ‚îÄ Section header (page-specific override: tighter margin + baseline align) ‚îÄ‚îÄ */
  .section-header {
    align-items: baseline;
    margin-bottom: 1.5rem;
  }

  /* .section-title is in global.css; local override for smaller size on this page */
  .section-title {
    font-size: 1.375rem;
    margin: 0;
  }

  .challenge-count {
    font-size: 0.875rem;
    color: var(--dim);
    font-weight: 400;
  }

  /* ‚îÄ‚îÄ Grid ‚îÄ‚îÄ */
  .challenge-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  /* .empty-state, .empty-icon are in global.css */

  /* ‚îÄ‚îÄ Leaderboard CTA ‚îÄ‚îÄ */
  .leaderboard-cta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1.5rem;
    margin-top: 3rem;
    padding: 1.5rem 2rem;
    flex-wrap: wrap;
  }

  .cta-content {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .cta-icon {
    font-size: 2rem;
    flex-shrink: 0;
  }

  .cta-title {
    font-size: 1.0625rem;
    font-weight: 700;
    color: var(--text);
    margin: 0 0 0.25rem;
  }

  .cta-desc {
    font-size: 0.9rem;
    color: var(--dim);
    margin: 0;
  }

  /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
  @media (max-width: 768px) {
    .how-cards {
      grid-template-columns: 1fr;
    }

    .challenge-grid {
      grid-template-columns: 1fr;
    }

    .page-title {
      font-size: 1.875rem;
    }

    .leaderboard-cta {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>
