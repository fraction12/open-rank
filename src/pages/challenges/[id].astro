---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import Badge from '../../components/Badge.astro';
import { getCurrentUser, supabaseAdmin } from '../../lib/supabase';

const { id } = Astro.params;

if (!id || !supabaseAdmin) return Astro.redirect('/challenges');

const today = new Date().toISOString().split('T')[0];

const { data: puzzle } = await supabaseAdmin
  .from('puzzles')
  .select('id, title, description, difficulty, category, input_data, release_date')
  .eq('id', id)
  .eq('category', 'agentic_engineering')
  .single();

if (!puzzle || puzzle.release_date > today) return Astro.redirect('/challenges');

const currentUser = await getCurrentUser(Astro.cookies);

interface TopHumanEntry {
  github_login: string;
  ai_tool: string | null;
  time_ms: number | null;
}

const { data: topHumansRaw } = await supabaseAdmin.rpc('leaderboard_humans_by_puzzle', {
  p_puzzle_id: id,
  p_limit: 5,
});
const topHumans = (topHumansRaw ?? []) as TopHumanEntry[];

// ‚îÄ‚îÄ Markdown renderer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMarkdown(text: string): string {
  const escape = (s: string) =>
    s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  const lines = text.split('\n');
  const out: string[] = [];
  let i = 0;
  while (i < lines.length) {
    if (lines[i].trim().startsWith('```')) {
      const lang = lines[i].trim().slice(3).trim();
      i++;
      const codeLines: string[] = [];
      while (i < lines.length && !lines[i].trim().startsWith('```')) {
        codeLines.push(escape(lines[i]));
        i++;
      }
      i++;
      out.push(`<pre><code class="language-${lang}">${codeLines.join('\n')}</code></pre>`);
      continue;
    }
    const line = lines[i];
    if (!line.trim()) { out.push('<br/>'); i++; continue; }
    let processed = escape(line);
    processed = processed.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    processed = processed.replace(/\*(.+?)\*/g, '<em>$1</em>');
    processed = processed.replace(/`(.+?)`/g, '<code>$1</code>');
    out.push(`<p>${processed}</p>`);
    i++;
  }
  return out.join('\n');
}

const difficultyLabel: Record<string, string> = {
  easy: 'EASY', medium: 'MEDIUM', hard: 'HARD', insane: 'INSANE',
};

const INPUT_DISPLAY_LIMIT = 3000;
const inputData = puzzle.input_data ?? '';
const isTruncated = inputData.length > INPUT_DISPLAY_LIMIT;
const displayData = isTruncated ? inputData.slice(0, INPUT_DISPLAY_LIMIT) : inputData;
---

<Layout
  title={`${puzzle.title} | OpenRank Challenges`}
  description={`Human challenge: ${puzzle.title}. Use your AI tools to solve this engineering problem.`}
>
  <div class="challenge-detail-page">
    <div class="container">

      <a href="/challenges" class="breadcrumb-link">‚Üê Challenges</a>

      <div class="challenge-grid">

        <!-- ‚îÄ‚îÄ Left: Main content ‚îÄ‚îÄ -->
        <main class="challenge-main">

          <!-- Header -->
          <header class="challenge-header">
            <div class="challenge-meta">
              <span class={`badge badge-${puzzle.difficulty}`}>{difficultyLabel[puzzle.difficulty] ?? puzzle.difficulty.toUpperCase()}</span>
              <Badge variant="ranked">üõ†Ô∏è Agentic Engineering</Badge>
              <time class="challenge-date" datetime={puzzle.release_date}>
                {new Date(puzzle.release_date).toLocaleDateString('en-US', {
                  weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC',
                })}
              </time>
            </div>
            <h1 class="challenge-title">{puzzle.title}</h1>
          </header>

          <!-- Description -->
          <section class="challenge-description card">
            <h2 class="section-heading">Description</h2>
            <div class="prose" set:html={renderMarkdown(puzzle.description)} />
          </section>

          <!-- Input Data -->
          <section class="challenge-input card">
            <div class="input-header">
              <h2 class="section-heading">Input Data</h2>
              <button class="btn btn-secondary btn-sm" id="copy-input-btn">Copy</button>
            </div>
            <pre class="input-data-pre"><code id="input-data-text">{displayData}{isTruncated ? '\n...(truncated)' : ''}</code></pre>
            {isTruncated && (
              <div class="truncation-notice">
                <span>Showing first {INPUT_DISPLAY_LIMIT.toLocaleString()} of {inputData.length.toLocaleString()} characters.</span>
                <button class="btn btn-secondary btn-sm" id="download-input">‚¨á Download full input</button>
              </div>
            )}
            {/* Hidden element holding full input for download handler ‚Äî Astro auto-escapes */}
            <div id="full-input-data" hidden aria-hidden="true">{inputData}</div>
          </section>

          <!-- Solve Section -->
          <section class="challenge-solve card" id="challenge-solve">
            <h2 class="section-heading">Solve This Challenge</h2>

            {currentUser ? (
              <div id="solve-container">
                <!-- State 1: Not started -->
                <div id="solve-start">
                  <p class="section-sub">Use any AI tool to find the answer. Timer starts when you click Start.</p>
                  <div class="scoring-pills">
                    <span class="score-pill-sm">‚úÖ 50pts correctness</span>
                    <span class="score-pill-sm">‚ö° up to 30pts speed</span>
                    <span class="score-pill-sm">üß† up to 8pts process</span>
                    <span class="score-pill-sm">üß™ up to 4pts verification</span>
                    <span class="score-pill-sm">üéØ up to 8pts attempt bonus</span>
                  </div>
                  <button class="btn btn-primary btn-lg" id="start-btn">‚ñ∂ Start Challenge</button>
                </div>

                <!-- State 2: In progress -->
                <div id="solve-active" style="display:none">
                  <div class="timer-display" id="timer-display" role="timer" aria-live="off" aria-label="Elapsed time" aria-atomic="true">0:00</div>
                  <p class="timer-sub">Timer running ‚Äî submit when ready</p>
                  {/* Screen-reader live region for key state announcements */}
                  <div id="sr-announcer" aria-live="polite" aria-atomic="true" class="sr-only"></div>

                  <div id="variant-brief" class="variant-brief" style="display:none">
                    <p class="variant-label">Session Variant</p>
                    <p class="variant-title" id="variant-title">Variant</p>
                    <p class="variant-text" id="variant-text"></p>
                    <p class="variant-criteria" id="variant-criteria"></p>
                  </div>

                  <div class="form-group">
                    <label class="form-label" for="ai_tool">AI Tool Used</label>
                    <select id="ai_tool" class="form-input">
                      <option value="">Select your tool...</option>
                      <option value="claude">Claude (Anthropic)</option>
                      <option value="gpt-4o">GPT-4o (OpenAI)</option>
                      <option value="gemini">Gemini (Google)</option>
                      <option value="cursor">Cursor</option>
                      <option value="copilot">GitHub Copilot</option>
                      <option value="grok">Grok (xAI)</option>
                      <option value="other">Other</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label class="form-label" for="challenge-answer">Your Answer</label>
                    <input type="text" id="challenge-answer" class="form-input"
                      placeholder="Type your answer..." autocomplete="off" />
                    <p class="form-hint">
                      Attempt <span id="attempt-count">1</span> ¬∑
                      <span id="efficiency-hint">First attempt = +8pts attempt bonus</span>
                    </p>
                  </div>

                  <details class="notes-panel">
                    <summary>Structured Notes (recommended for full rubric score)</summary>
                    <div class="notes-grid">
                      <div class="form-group">
                        <label class="form-label" for="root_cause">Root Cause</label>
                        <textarea id="root_cause" class="form-input form-textarea" placeholder="What actually caused the issue?"></textarea>
                      </div>
                      <div class="form-group">
                        <label class="form-label" for="fix_plan">Fix Plan</label>
                        <textarea id="fix_plan" class="form-input form-textarea" placeholder="What exact patch are you applying and why?"></textarea>
                      </div>
                      <div class="form-group">
                        <label class="form-label" for="verification_steps">Verification Steps</label>
                        <textarea id="verification_steps" class="form-input form-textarea" placeholder="How did you verify the fix and edge cases?"></textarea>
                      </div>
                      <div class="form-group">
                        <label class="form-label" for="confidence_level">Confidence</label>
                        <select id="confidence_level" class="form-input">
                          <option value="">Select confidence...</option>
                          <option value="1">1 - Low</option>
                          <option value="2">2</option>
                          <option value="3">3 - Medium</option>
                          <option value="4">4</option>
                          <option value="5">5 - High</option>
                        </select>
                      </div>
                    </div>
                  </details>

                  <div class="hints-panel">
                    <p class="form-label">Coach Mode</p>
                    <p class="form-hint">Need help? Reveal hints one by one. Each hint slightly reduces rubric bonus.</p>
                    <button type="button" class="btn btn-secondary btn-sm" id="hint-btn">Reveal next hint</button>
                    <ul id="hint-list" class="hint-list"></ul>
                  </div>

                  <button class="btn btn-primary" id="submit-btn">Submit Answer</button>
                  <div id="challenge-result" class="submit-result" aria-live="polite"></div>
                </div>

                <!-- State 3: Solved -->
                <div id="solve-done" style="display:none" class="solve-success">
                  <div class="success-badge">‚úÖ Challenge Complete</div>
                  <div class="solved-with" id="solved-with"></div>
                  <div class="score-breakdown" id="score-breakdown"></div>
                  <a href="/leaderboard?tab=humans" class="btn btn-secondary" style="margin-top:1rem">View Leaderboard ‚Üí</a>
                </div>
              </div>
            ) : (
              <div>
                <div class="callout callout-muted">
                  <a href="/api/auth/signin">Sign in with GitHub ‚Üí</a> to compete on the human leaderboard.
                </div>
                <p class="form-hint" style="margin-top:0.75rem">Your score will appear alongside other humans using AI tools.</p>
              </div>
            )}
          </section>

        </main>

        <!-- ‚îÄ‚îÄ Right: Sidebar ‚îÄ‚îÄ -->
        <aside class="challenge-sidebar">

          <!-- Top Humans -->
          <div class="sidebar-card card">
            <h3 class="sidebar-heading">üèÖ Top Humans</h3>
            <p class="sidebar-sub">Fastest correct solutions</p>
            {!topHumans || topHumans.length === 0 ? (
              <div class="empty-leaderboard">
                <span class="empty-trophy">üèÜ</span>
                <p>No entries yet.<br/>Be the first!</p>
              </div>
            ) : (
              <div class="human-entries">
                {topHumans.slice(0, 5).map((entry, i) => (
                  <div class="human-entry">
                    <span class="entry-rank">
                      {i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `#${i + 1}`}
                    </span>
                    <a href={`/profile/${entry.github_login}`} class="entry-login">
                      @{entry.github_login}
                    </a>
                    <span class="entry-tool">{entry.ai_tool ?? '‚Äî'}</span>
                    <span class="entry-time mono-sm">
                      {entry.time_ms ? `${(entry.time_ms / 1000).toFixed(1)}s` : '‚Äî'}
                    </span>
                  </div>
                ))}
              </div>
            )}
            <a href="/leaderboard?tab=humans" class="sidebar-more">View full leaderboard ‚Üí</a>
          </div>

          <!-- Scoring -->
          <div class="sidebar-card card">
            <h3 class="sidebar-heading">Scoring</h3>
            <ul class="scoring-list">
              <li><span class="dot dot-green"></span><span>Correctness</span><span class="score-max">50pts</span></li>
              <li><span class="dot dot-blue"></span><span>Speed bonus</span><span class="score-max">up to 30</span></li>
              <li><span class="dot dot-yellow"></span><span>Process quality</span><span class="score-max">up to 8</span></li>
              <li><span class="dot dot-yellow dim-dot"></span><span>Verification quality</span><span class="score-max">up to 4</span></li>
              <li><span class="dot dot-yellow dim-dot"></span><span>Attempt bonus</span><span class="score-max">up to 8</span></li>
            </ul>
          </div>

          <!-- Tips -->
          <div class="sidebar-card card">
            <h3 class="sidebar-heading">üí° Tips</h3>
            <ul class="tips-list">
              <li>Share <strong>all</strong> the context ‚Äî full code, full error messages</li>
              <li>Ask <em>why</em> not just <em>what</em> ‚Äî better reasoning = better answers</li>
              <li>Verify before submitting ‚Äî have AI explain <em>why</em> it's correct first</li>
              <li><strong>First attempt = max bonus</strong> ‚Äî think before you click Submit</li>
            </ul>
          </div>

        </aside>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { noticeFromResponse } from '../../lib/http-error';
  import { normalizeNotice, showNotice } from '../../lib/notify';
  import { toastInfo, toastSuccess, toastWarning } from '../../lib/toast';
</script>
<script define:vars={{ puzzleId: puzzle.id, isLoggedIn: !!currentUser }}>

  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content ?? '';

  // ‚îÄ‚îÄ Copy input data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('copy-input-btn')?.addEventListener('click', async () => {
    const text = document.getElementById('input-data-text')?.textContent ?? '';
    const btn = document.getElementById('copy-input-btn');
    try {
      await navigator.clipboard.writeText(text);
      toastSuccess('Copied', 'Challenge input copied to clipboard.');
      if (btn) { btn.textContent = 'Copied!'; setTimeout(() => { if (btn) btn.textContent = 'Copy'; }, 2000); }
    } catch {
      toastWarning('Copy failed', 'Unable to copy automatically. You can copy manually.');
      if (btn) { btn.textContent = 'Copy failed'; setTimeout(() => { if (btn) btn.textContent = 'Copy'; }, 2000); }
    }
  });

  if (!isLoggedIn) return;

  // ‚îÄ‚îÄ Download full input ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const downloadBtn = document.getElementById('download-input');
  if (downloadBtn) {
    downloadBtn.addEventListener('click', () => {
      const fullData = document.getElementById('full-input-data')?.textContent ?? '';
      const blob = new Blob([fullData], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'challenge-input-' + puzzleId + '.txt';
      a.click();
      URL.revokeObjectURL(url);
    });
  }

  // ‚îÄ‚îÄ Screen-reader announcer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function announce(msg) {
    const el = document.getElementById('sr-announcer');
    if (el) {
      el.textContent = '';
      requestAnimationFrame(() => { el.textContent = msg; });
    }
  }

  // ‚îÄ‚îÄ Timer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let timerInterval = null;
  let startTimestamp = null;
  let sessionId = null;
  let variantId = null;
  let variantHints = [];
  let hintsUsed = 0;
  let attemptCount = 0;
  function setBusyState(button, busyLabel) {
    if (!button) return () => {};
    const originalLabel = button.textContent ?? '';
    button.textContent = busyLabel;
    button.disabled = true;
    button.setAttribute('aria-busy', 'true');
    return () => {
      button.textContent = originalLabel;
      button.disabled = false;
      button.removeAttribute('aria-busy');
    };
  }

  function formatTime(ms) {
    const s = Math.floor(ms / 1000);
    const m = Math.floor(s / 60);
    return `${m}:${String(s % 60).padStart(2, '0')}`;
  }

  // ‚îÄ‚îÄ Start ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('start-btn')?.addEventListener('click', async () => {
    const startBtn = document.getElementById('start-btn');
    if (startBtn?.disabled) return;
    const restoreStartBtn = setBusyState(startBtn, 'Starting...');

    try {
      const res = await fetch('/api/puzzle/start-challenge', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify({ puzzle_id: puzzleId }),
      });
      if (!res.ok) {
        throw await noticeFromResponse(res, 'Failed to start challenge. Please refresh and try again.');
      }
      const data = await res.json();
      if (!data.session_id) {
        throw new Error('No session returned');
      }
      sessionId = data.session_id;
      variantId = data.variant?.id ?? null;
      variantHints = Array.isArray(data.variant?.hint_track) ? data.variant.hint_track : [];
      hintsUsed = 0;

      const variantEl = document.getElementById('variant-brief');
      const variantTitle = document.getElementById('variant-title');
      const variantText = document.getElementById('variant-text');
      const variantCriteria = document.getElementById('variant-criteria');
      const hintList = document.getElementById('hint-list');
      const hintBtn = document.getElementById('hint-btn');
      if (hintList) hintList.innerHTML = '';
      if (hintBtn) hintBtn.removeAttribute('disabled');
      if (variantId && variantEl && variantTitle && variantText && variantCriteria) {
        variantTitle.textContent = data.variant?.title ?? 'Session Variant';
        variantText.textContent = data.variant?.brief ?? '';
        variantCriteria.textContent = `Success criteria: ${data.variant?.success_criteria ?? 'Ship a safe and verifiable fix.'}`;
        variantEl.style.display = 'block';
      }
    } catch (err) {
      showNotice(normalizeNotice(err, 'Failed to start challenge. Please refresh and try again.'));
      restoreStartBtn();
      const errorEl = document.createElement('p');
      errorEl.style.cssText = 'color:var(--error);font-size:0.875rem;margin-top:0.75rem;';
      errorEl.textContent = 'Failed to start challenge. Please refresh and try again.';
      startBtn.insertAdjacentElement('afterend', errorEl);
      return; // Do NOT start the timer
    }

    startTimestamp = Date.now();
    attemptCount = 0;

    document.getElementById('solve-start').style.display = 'none';
    document.getElementById('solve-active').style.display = 'block';
    announce('Challenge started. Timer running.');

    timerInterval = setInterval(() => {
      const elapsed = Date.now() - startTimestamp;
      const el = document.getElementById('timer-display');
      if (el) el.textContent = formatTime(elapsed);
    }, 100);
  });

  document.getElementById('hint-btn')?.addEventListener('click', () => {
    const hintList = document.getElementById('hint-list');
    if (!hintList) return;
    if (hintsUsed >= variantHints.length || hintsUsed >= 3) return;

    const li = document.createElement('li');
    li.textContent = variantHints[hintsUsed] ?? 'Re-check assumptions and validate edge cases.';
    hintList.appendChild(li);
    hintsUsed += 1;

    if (hintsUsed >= 3 || hintsUsed >= variantHints.length) {
      const btn = document.getElementById('hint-btn');
      if (btn) btn.setAttribute('disabled', 'true');
    }
  });

  // ‚îÄ‚îÄ Submit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('submit-btn')?.addEventListener('click', async () => {
    const answer = document.getElementById('challenge-answer')?.value?.trim();
    const ai_tool = document.getElementById('ai_tool')?.value;
    const rootCause = document.getElementById('root_cause')?.value?.trim() ?? '';
    const fixPlan = document.getElementById('fix_plan')?.value?.trim() ?? '';
    const verificationSteps = document.getElementById('verification_steps')?.value?.trim() ?? '';
    const confidenceRaw = document.getElementById('confidence_level')?.value ?? '';
    const confidenceLevel = confidenceRaw ? Number.parseInt(confidenceRaw, 10) : undefined;
    const resultEl = document.getElementById('challenge-result');
    const submitBtn = document.getElementById('submit-btn');
    if (submitBtn?.disabled) return;

    if (!answer) { resultEl.textContent = 'Please enter your answer.'; return; }
    if (!ai_tool) { resultEl.textContent = 'Please select your AI tool.'; return; }

    const restoreSubmitBtn = setBusyState(submitBtn, 'Submitting...');
    attemptCount++;

    try {
      const res = await fetch('/api/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify({
          puzzle_id: puzzleId,
          answer,
          session_id: sessionId,
          ai_tool,
          variant_id: variantId,
          hints_used: hintsUsed,
          root_cause: rootCause || undefined,
          fix_plan: fixPlan || undefined,
          verification_steps: verificationSteps || undefined,
          confidence_level: Number.isFinite(confidenceLevel) ? confidenceLevel : undefined,
        }),
      });
      const result = await res.json();

      if (!res.ok) {
        showNotice(await noticeFromResponse(res, result.error ?? 'Submission failed. Please try again.'));
        resultEl.innerHTML = `<span class="result-error">‚ö†Ô∏è ${result.error ?? 'Submission failed. Please try again.'}</span>`;
        restoreSubmitBtn();
        return;
      }

      if (result.correct) {
        if (timerInterval) clearInterval(timerInterval);
        const elapsed = startTimestamp ? Date.now() - startTimestamp : 0;
        announce('Correct! Challenge complete.');

        // Get tool display name
        const toolSelect = document.getElementById('ai_tool');
        const toolName = toolSelect?.options[toolSelect.selectedIndex]?.text ?? ai_tool;

        document.getElementById('solve-active').style.display = 'none';
        const doneEl = document.getElementById('solve-done');
        doneEl.style.display = 'block';

        document.getElementById('solved-with').textContent =
          `Solved with ${toolName} in ${formatTime(elapsed)} ‚Äî Score: ${result.score}/100`;

        const b = result.breakdown ?? {};
        const hr = result.human_rubric ?? {};
        document.getElementById('score-breakdown').innerHTML = [
          `<span class="score-pill-sm">‚úÖ ${b.correctness ?? 50}pts correctness</span>`,
          `<span class="score-pill-sm">‚ö° ${b.speed_bonus ?? 0}pts speed</span>`,
          `<span class="score-pill-sm">üß† ${hr.process_bonus ?? 0}pts process</span>`,
          `<span class="score-pill-sm">üß™ ${hr.verification_bonus ?? 0}pts verification</span>`,
          `<span class="score-pill-sm">üéØ ${hr.attempt_bonus ?? 0}pts attempt</span>`,
        ].join('');
        toastSuccess('Challenge solved', `Score ${result.score}/100.`);
      } else {
        const nextAttempt = attemptCount + 1;
        document.getElementById('attempt-count').textContent = String(nextAttempt);
        const hints = ['', '+8pts', '+4pts', '+2pts'];
        const hintEl = document.getElementById('efficiency-hint');
        if (nextAttempt <= 3) {
          hintEl.textContent = `Next attempt bonus: ${hints[nextAttempt]} attempt`;
        } else {
          hintEl.textContent = 'No attempt bonus remaining';
        }
        resultEl.innerHTML = '‚ùå Incorrect ‚Äî try again.';
        toastInfo('Incorrect answer', 'Keep going. You can submit again.');
        restoreSubmitBtn();
      }
    } catch (err) {
      // Network / unexpected error ‚Äî show visible message, re-enable submit
      showNotice(normalizeNotice(err, 'Network error. Please check your connection and try again.'));
      resultEl.innerHTML = '<span class="result-error">‚ö†Ô∏è Network error. Please check your connection and try again.</span>';
      restoreSubmitBtn();
    }
  });
</script>

<style>
  .challenge-detail-page {
    padding: 2rem 0 5rem;
  }

  .breadcrumb-link {
    display: inline-block;
    font-size: 0.875rem;
    color: var(--dim);
    text-decoration: none;
    margin-bottom: 1.5rem;
    transition: color 0.15s;
  }
  .breadcrumb-link:hover { color: var(--text); }

  /* ‚îÄ‚îÄ Two-column grid ‚îÄ‚îÄ */
  .challenge-grid {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 2rem;
    align-items: start;
  }

  .challenge-main {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    min-width: 0;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .challenge-meta {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    flex-wrap: wrap;
    margin-bottom: 0.625rem;
  }

  .challenge-date {
    font-size: 0.875rem;
    color: var(--dim);
  }

  .challenge-title {
    font-size: 2rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    color: var(--text);
    margin: 0;
    line-height: 1.2;
  }

  /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
  .section-heading {
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--dim);
    margin: 0 0 1rem;
  }

  .section-sub {
    font-size: 0.9375rem;
    color: var(--dim);
    margin: -0.5rem 0 1.25rem;
  }

  /* ‚îÄ‚îÄ Input data ‚îÄ‚îÄ */
  .input-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.75rem;
  }

  .input-header .section-heading { margin: 0; }

  .input-data-pre {
    max-height: 320px;
    overflow-x: auto;
    overflow-y: auto;
  }

  /* ‚îÄ‚îÄ Scoring pills ‚îÄ‚îÄ */
  .scoring-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .score-pill-sm {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 99px;
    font-size: 0.8125rem;
    color: var(--text);
  }

  /* ‚îÄ‚îÄ Timer ‚îÄ‚îÄ */
  .timer-display {
    font-size: 3.5rem;
    font-weight: 800;
    font-variant-numeric: tabular-nums;
    letter-spacing: -0.03em;
    color: var(--accent);
    line-height: 1;
    margin: 0.5rem 0 0.25rem;
  }

  .timer-sub {
    font-size: 0.875rem;
    color: var(--dim);
    margin: 0 0 1.5rem;
  }

  /* ‚îÄ‚îÄ Form ‚îÄ‚îÄ */
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
    margin-bottom: 1rem;
  }

  .form-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text);
  }

  .form-input {
    padding: 0.625rem 0.875rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--bg);
    color: var(--text);
    font-size: 0.9375rem;
    font-family: inherit;
    transition: border-color 0.15s;
    width: 100%;
    box-sizing: border-box;
  }
  .form-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
  }

  .form-textarea {
    min-height: 84px;
    resize: vertical;
  }

  .variant-brief {
    border: 1px solid var(--border);
    background: var(--surface);
    border-radius: var(--radius);
    padding: 0.875rem;
    margin-bottom: 1rem;
  }

  .variant-label {
    font-size: 0.75rem;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 0.25rem;
  }

  .variant-title {
    margin: 0;
    font-weight: 700;
    color: var(--text);
  }

  .variant-text,
  .variant-criteria {
    margin: 0.35rem 0 0;
    font-size: 0.875rem;
    color: var(--dim);
  }

  .notes-panel {
    margin: 1rem 0 1rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
    padding: 0.625rem 0.875rem;
  }

  .notes-panel summary {
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text);
  }

  .notes-grid {
    margin-top: 0.875rem;
  }

  .hints-panel {
    margin-bottom: 1rem;
    padding: 0.75rem 0.875rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
  }

  .hint-list {
    margin: 0.75rem 0 0;
    padding-left: 1.15rem;
    color: var(--dim);
    font-size: 0.875rem;
    line-height: 1.6;
  }

  .form-hint {
    font-size: 0.8125rem;
    color: var(--dim);
    margin: 0;
  }

  .submit-result {
    margin-top: 0.75rem;
    font-size: 0.9375rem;
    min-height: 1.5rem;
  }

  /* ‚îÄ‚îÄ Solved state ‚îÄ‚îÄ */
  .solve-success {
    text-align: center;
    padding: 1.5rem 0.5rem;
  }

  .success-badge {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--success);
    margin-bottom: 0.75rem;
  }

  .solved-with {
    font-size: 1.0625rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 1rem;
  }

  .score-breakdown {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  /* ‚îÄ‚îÄ Start button ‚îÄ‚îÄ */
  .btn-lg {
    padding: 0.875rem 2rem;
    font-size: 1rem;
    margin-top: 0.5rem;
  }

  /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
  .challenge-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    position: sticky;
    top: 5rem;
  }

  .sidebar-card { padding: 1.25rem; }

  .sidebar-heading {
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--dim);
    margin: 0 0 0.5rem;
  }

  .sidebar-sub {
    font-size: 0.8125rem;
    color: var(--dim);
    margin: 0 0 1rem;
  }

  .sidebar-more {
    display: block;
    font-size: 0.8125rem;
    color: var(--accent);
    text-decoration: none;
    margin-top: 1rem;
    text-align: center;
  }
  .sidebar-more:hover { text-decoration: underline; }

  /* ‚îÄ‚îÄ Human entries ‚îÄ‚îÄ */
  .human-entries {
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
  }

  .human-entry {
    display: grid;
    grid-template-columns: 1.5rem 1fr auto auto;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
  }

  .entry-rank { text-align: center; font-size: 0.9rem; }

  .entry-login {
    color: var(--accent);
    text-decoration: none;
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .entry-login:hover { text-decoration: underline; }

  .entry-tool {
    font-size: 0.75rem;
    color: var(--dim);
    background: var(--surface);
    padding: 0.1em 0.45em;
    border-radius: 4px;
    border: 1px solid var(--border);
    white-space: nowrap;
  }

  .mono-sm {
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    color: var(--dim);
    white-space: nowrap;
  }

  .empty-leaderboard {
    text-align: center;
    padding: 1.5rem 0;
    color: var(--dim);
    font-size: 0.875rem;
  }

  .empty-trophy { font-size: 2rem; display: block; margin-bottom: 0.5rem; }

  /* ‚îÄ‚îÄ Scoring list ‚îÄ‚îÄ */
  .scoring-list {
    list-style: none;
    padding: 0;
    margin: 0.5rem 0 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .scoring-list li {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--dim);
  }

  .scoring-list li span:nth-child(2) { flex: 1; }

  .score-max {
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .dot-green  { background: var(--success); }
  .dot-blue   { background: var(--accent); }
  .dot-yellow { background: var(--warning-vivid); }
  .dim-dot    { opacity: 0.5; }

  /* ‚îÄ‚îÄ Tips ‚îÄ‚îÄ */
  .tips-list {
    list-style: none;
    padding: 0;
    margin: 0.5rem 0 0;
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
  }

  .tips-list li {
    font-size: 0.875rem;
    color: var(--dim);
    line-height: 1.5;
    padding-left: 1rem;
    position: relative;
  }

  .tips-list li::before {
    content: '‚Üí';
    position: absolute;
    left: 0;
    color: var(--accent);
    font-size: 0.75rem;
    top: 0.1em;
  }

  .tips-list strong { color: var(--text); }
  .tips-list em { color: var(--text); font-style: italic; }

  /* ‚îÄ‚îÄ Callout ‚îÄ‚îÄ */
  .callout-muted {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.875rem 1rem;
    font-size: 0.9375rem;
    color: var(--dim);
  }

  /* ‚îÄ‚îÄ Accessibility ‚îÄ‚îÄ */
  .sr-only {
    position: absolute;
    width: 1px; height: 1px;
    padding: 0; margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* ‚îÄ‚îÄ Download / truncation notice ‚îÄ‚îÄ */
  .truncation-notice {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-top: 0.5rem;
    font-size: 0.8125rem;
    color: var(--dim);
    flex-wrap: wrap;
  }

  /* ‚îÄ‚îÄ Network error in result area ‚îÄ‚îÄ */
  .result-error {
    color: var(--error);
    font-size: 0.9375rem;
  }

  /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
  @media (max-width: 900px) {
    .challenge-grid {
      grid-template-columns: 1fr;
    }
    .challenge-sidebar {
      position: static;
    }
    .challenge-title {
      font-size: 1.5rem;
    }
  }
</style>
