---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { getCurrentUser, supabase } from '../../lib/supabase';

const { id } = Astro.params;

// â”€â”€ Fetch puzzle (agentic_engineering only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let puzzle: {
  id: string;
  title: string;
  description: string;
  difficulty: string;
  category: string;
  input_data: string | null;
  release_date: string;
} | null = null;

if (supabase && id) {
  const { data } = await supabase
    .from('puzzles')
    .select('id, title, description, difficulty, category, input_data, release_date')
    .eq('id', id)
    .eq('category', 'agentic_engineering')
    .single();
  puzzle = data ?? null;
}

// If not found â†’ redirect
if (!puzzle) {
  return Astro.redirect('/challenges');
}

// If not yet released â†’ redirect
const todayStr = new Date().toISOString().split('T')[0];
if (puzzle.release_date > todayStr) {
  return Astro.redirect('/challenges');
}

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const currentUser = await getCurrentUser(Astro.cookies);

// â”€â”€ Top 5 human submissions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let topHumans: Array<{
  github_login: string;
  ai_tool: string | null;
  time_ms: number | null;
  score: number;
}> = [];

if (supabase) {
  const { data } = await supabase.rpc('leaderboard_humans_by_puzzle', {
    p_puzzle_id: id,
    p_limit: 5,
  });
  topHumans = data ?? [];
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const formattedDate = new Date(puzzle.release_date).toLocaleDateString('en-US', {
  weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
  timeZone: 'UTC',
});

// â”€â”€ Markdown renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMarkdown(text: string): string {
  const escape = (s: string) =>
    s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

  const lines = text.split('\n');
  const out: string[] = [];
  let i = 0;

  while (i < lines.length) {
    if (lines[i].trim().startsWith('```')) {
      const lang = lines[i].trim().slice(3).trim();
      i++;
      const codeLines: string[] = [];
      while (i < lines.length && !lines[i].trim().startsWith('```')) {
        codeLines.push(escape(lines[i]));
        i++;
      }
      i++;
      out.push(`<pre><code class="language-${lang}">${codeLines.join('\n')}</code></pre>`);
      continue;
    }

    const line = lines[i];
    if (!line.trim()) {
      out.push('<br />');
      i++;
      continue;
    }

    const rendered = escape(line)
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/`([^`]+)`/g, '<code>$1</code>');
    out.push(`<p>${rendered}</p>`);
    i++;
  }

  return out.join('');
}

const isDownloadInput = puzzle.input_data?.startsWith('/') ?? false;
const inputPreview = puzzle.input_data
  ? (puzzle.input_data.slice(0, 2000) + (puzzle.input_data.length > 2000 ? '\n...(truncated)' : ''))
  : '';
---

<Layout title={puzzle.title} description={puzzle.description.slice(0, 160)}>
  <!-- Inline puzzleId for the client script -->
  <script define:vars={{ puzzleId: puzzle.id }} is:inline>
    window.__challengePuzzleId = puzzleId;
  </script>

  <div class="challenge-page">
    <div class="container">

      <!-- â”€â”€ Breadcrumb â”€â”€ -->
      <div class="breadcrumb">
        <a href="/challenges" class="breadcrumb-link">â† Challenges</a>
      </div>

      <!-- â”€â”€ Main grid â”€â”€ -->
      <div class="challenge-grid">

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• LEFT COLUMN â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <main class="challenge-main">

          <!-- Header -->
          <header class="challenge-header">
            <div class="puzzle-meta">
              <span class={`badge badge-${puzzle.difficulty}`}>{puzzle.difficulty}</span>
              <span class="badge-category">ğŸ› ï¸ Agentic Engineering</span>
              <time class="puzzle-date" datetime={puzzle.release_date}>{formattedDate}</time>
            </div>
            <h1 class="puzzle-title">{puzzle.title}</h1>
          </header>

          <!-- Description -->
          <section class="card">
            <h2 class="section-heading">Description</h2>
            <div class="prose" set:html={renderMarkdown(puzzle.description)} />
          </section>

          <!-- Input Data -->
          {isDownloadInput ? (
            <section class="challenge-input card">
              <div class="input-header">
                <h2 class="section-heading">Input Data</h2>
                <a href={puzzle.input_data!} download class="btn btn-secondary btn-sm">â¬‡ Download</a>
              </div>
              <p class="input-note">
                This challenge uses a large input file. Download it at:
                <code>{puzzle.input_data}</code>
              </p>
            </section>
          ) : (
            <section class="challenge-input card">
              <div class="input-header">
                <h2 class="section-heading">Input Data</h2>
                <button class="btn btn-secondary btn-sm" id="copy-input-btn">Copy</button>
              </div>
              <pre class="input-data-pre"><code id="input-data-text">{inputPreview}</code></pre>
            </section>
          )}

          <!-- â”€â”€ Solve Section â”€â”€ -->
          {currentUser ? (
            <section class="challenge-solve card" id="challenge-solve">
              <h2 class="section-heading">Solve This Challenge</h2>

              <!-- State 1: Not started -->
              <div id="solve-start">
                <p class="section-sub">Use any AI tool to find the answer. Timer starts when you click Start.</p>
                <div class="scoring-summary">
                  <span class="score-pill-sm">âœ… 50pts correctness</span>
                  <span class="score-pill-sm">âš¡ up to 30pts speed</span>
                  <span class="score-pill-sm">ğŸ¯ +20pts first attempt</span>
                </div>
                <button class="btn btn-primary btn-lg" id="start-btn">Start Challenge</button>
              </div>

              <!-- State 2: In progress -->
              <div id="solve-active" style="display:none">
                <div class="timer-display" id="timer-display">0:00</div>
                <p class="timer-sub">Timer running â€” submit when ready</p>

                <div class="form-group">
                  <label class="form-label" for="ai_tool">AI Tool Used</label>
                  <select id="ai_tool" class="form-input form-select">
                    <option value="">Select your tool...</option>
                    <option value="claude">Claude (Anthropic)</option>
                    <option value="gpt-4o">GPT-4o (OpenAI)</option>
                    <option value="gemini">Gemini (Google)</option>
                    <option value="cursor">Cursor</option>
                    <option value="copilot">GitHub Copilot</option>
                    <option value="grok">Grok (xAI)</option>
                    <option value="other">Other</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label" for="challenge-answer">Your Answer</label>
                  <input
                    type="text"
                    id="challenge-answer"
                    class="form-input"
                    placeholder="Type your answer..."
                    autocomplete="off"
                  />
                  <p class="form-hint">
                    Attempt <span id="attempt-count">1</span>
                    Â· <span id="efficiency-hint">First attempt = +20pts efficiency bonus</span>
                  </p>
                </div>

                <button class="btn btn-primary" id="submit-btn">Submit Answer</button>
                <div id="challenge-result" class="submit-result" aria-live="polite"></div>
              </div>

              <!-- State 3: Solved -->
              <div id="solve-done" style="display:none" class="solve-success">
                <div class="success-badge">âœ… Challenge Complete</div>
                <div class="solved-with" id="solved-with"></div>
                <div class="score-breakdown" id="score-breakdown"></div>
              </div>
            </section>
          ) : (
            <section class="challenge-solve card">
              <h2 class="section-heading">Solve This Challenge</h2>
              <div class="callout callout-muted">
                <a href="/api/auth/signin">Sign in with GitHub â†’</a> to compete on the human leaderboard.
              </div>
              <p class="form-hint">Practice mode: you can still try the challenge but won't appear on the leaderboard.</p>

              <div style="margin-top: 1.25rem;">
                <div class="form-group">
                  <label class="form-label" for="ai_tool_guest">AI Tool Used</label>
                  <select id="ai_tool_guest" class="form-input form-select">
                    <option value="">Select your tool...</option>
                    <option value="claude">Claude (Anthropic)</option>
                    <option value="gpt-4o">GPT-4o (OpenAI)</option>
                    <option value="gemini">Gemini (Google)</option>
                    <option value="cursor">Cursor</option>
                    <option value="copilot">GitHub Copilot</option>
                    <option value="grok">Grok (xAI)</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label" for="challenge-answer-guest">Your Answer</label>
                  <input
                    type="text"
                    id="challenge-answer-guest"
                    class="form-input"
                    placeholder="Type your answer..."
                    autocomplete="off"
                  />
                </div>
                <button class="btn btn-secondary" id="guest-submit-btn">Try Answer (Practice)</button>
                <div id="guest-result" class="submit-result" aria-live="polite"></div>
              </div>
            </section>
          )}

        </main>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• RIGHT SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <aside class="challenge-sidebar">

          <!-- Top Humans -->
          <div class="sidebar-card card">
            <h3 class="sidebar-heading">ğŸ… Top Humans</h3>
            <p class="sidebar-sub">Fastest correct solutions</p>

            {topHumans.length === 0 ? (
              <div class="empty-leaderboard">
                <span class="empty-trophy">ğŸ†</span>
                <p>No entries yet.<br />Be the first!</p>
              </div>
            ) : (
              <div class="human-entries">
                {topHumans.slice(0, 5).map((entry, i) => (
                  <div class="human-entry">
                    <span class="entry-rank">
                      {i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `#${i + 1}`}
                    </span>
                    <a href={`/profile/${entry.github_login}`} class="entry-login">@{entry.github_login}</a>
                    <span class="entry-tool">{entry.ai_tool ?? 'â€”'}</span>
                    <span class="entry-time">
                      {entry.time_ms ? `${(entry.time_ms / 1000).toFixed(1)}s` : 'â€”'}
                    </span>
                  </div>
                ))}
              </div>
            )}

            <a href="/leaderboard?tab=humans" class="sidebar-more">View full leaderboard â†’</a>
          </div>

          <!-- Scoring -->
          <div class="sidebar-card card">
            <h3 class="sidebar-heading">Scoring</h3>
            <ul class="scoring-list">
              <li><span class="dot dot-green"></span> Correctness <span class="score-max">50pts</span></li>
              <li><span class="dot dot-blue"></span> Speed bonus <span class="score-max">up to 30</span></li>
              <li><span class="dot dot-yellow"></span> 1st attempt <span class="score-max">+20pts</span></li>
              <li><span class="dot dot-yellow"></span> 2nd attempt <span class="score-max">+10pts</span></li>
              <li><span class="dot dot-yellow"></span> 3rd attempt <span class="score-max">+5pts</span></li>
            </ul>
          </div>

          <!-- Tips -->
          <div class="sidebar-card card">
            <h3 class="sidebar-heading">ğŸ’¡ Tips</h3>
            <ul class="tips-list">
              <li>Share <strong>all</strong> the context with your AI tool â€” full snippets, full errors</li>
              <li>Ask <em>why</em>, not just <em>what</em> â€” better reasoning leads to better answers</li>
              <li>Verify before submitting â€” have your AI explain why the answer is correct</li>
              <li>First attempt earns maximum efficiency bonus â€” take your time before clicking Submit</li>
            </ul>
          </div>

        </aside>

      </div>
    </div>
  </div>
</Layout>

<script>
  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const puzzleId: string = (window as any).__challengePuzzleId;

  let timerInterval: ReturnType<typeof setInterval> | null = null;
  let startTimestamp: number | null = null;
  let sessionId: string | null = null;
  let attemptCount = 0;

  function formatTime(ms: number): string {
    const s = Math.floor(ms / 1000);
    const m = Math.floor(s / 60);
    return `${m}:${String(s % 60).padStart(2, '0')}`;
  }

  // â”€â”€ Start button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('start-btn')?.addEventListener('click', async () => {
    try {
      const res = await fetch('/api/puzzle/start-challenge', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ puzzle_id: puzzleId }),
      });
      const data = await res.json();
      if (!res.ok) {
        alert(data.error ?? 'Failed to start challenge.');
        return;
      }
      sessionId = data.session_id ?? null;
    } catch {
      // If start-challenge fails, continue without a session (untracked)
      sessionId = null;
    }

    startTimestamp = Date.now();
    attemptCount = 0;

    const startSection = document.getElementById('solve-start');
    const activeSection = document.getElementById('solve-active');
    if (startSection) startSection.style.display = 'none';
    if (activeSection) activeSection.style.display = 'block';

    timerInterval = setInterval(() => {
      if (startTimestamp !== null) {
        document.getElementById('timer-display')!.textContent = formatTime(Date.now() - startTimestamp);
      }
    }, 100);
  });

  // â”€â”€ Submit button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('submit-btn')?.addEventListener('click', async () => {
    const answerEl = document.getElementById('challenge-answer') as HTMLInputElement | null;
    const toolEl = document.getElementById('ai_tool') as HTMLSelectElement | null;
    const resultEl = document.getElementById('challenge-result')!;

    const answer = answerEl?.value.trim() ?? '';
    const ai_tool = toolEl?.value ?? '';

    if (!answer) { resultEl.textContent = 'Please enter your answer.'; return; }
    if (!ai_tool) { resultEl.textContent = 'Please select your AI tool.'; return; }

    attemptCount++;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    submitBtn.textContent = 'Submitting...';
    submitBtn.disabled = true;

    try {
      const res = await fetch('/api/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          puzzle_id: puzzleId,
          answer,
          session_id: sessionId,
          ai_tool,
          is_human: true,
        }),
      });
      const result = await res.json();

      if (result.correct) {
        if (timerInterval) clearInterval(timerInterval);
        const elapsed = startTimestamp ? Date.now() - startTimestamp : 0;

        const activeSection = document.getElementById('solve-active');
        const doneSection = document.getElementById('solve-done');
        if (activeSection) activeSection.style.display = 'none';
        if (doneSection) doneSection.style.display = 'block';

        const selectedTool = toolEl?.options[toolEl.selectedIndex]?.text ?? ai_tool;
        const solvedWithEl = document.getElementById('solved-with');
        if (solvedWithEl) {
          solvedWithEl.textContent = `Solved with ${selectedTool} in ${formatTime(elapsed)} â€” Score: ${result.score}/100`;
        }

        const b = result.breakdown ?? {};
        const breakdownEl = document.getElementById('score-breakdown');
        if (breakdownEl) {
          breakdownEl.innerHTML = `
            <span class="score-pill-sm">âœ… ${b.correctness ?? 50}pts</span>
            <span class="score-pill-sm">âš¡ ${b.speed_bonus ?? 0}pts speed</span>
            <span class="score-pill-sm">ğŸ¯ ${b.efficiency_bonus ?? 0}pts efficiency</span>
          `;
        }
      } else {
        const effHints = ['', 'First attempt = +20pts efficiency bonus', '+10pts efficiency bonus', '+5pts efficiency bonus'];
        const nextAttempt = attemptCount + 1;
        const attemptEl = document.getElementById('attempt-count');
        const hintEl = document.getElementById('efficiency-hint');
        if (attemptEl) attemptEl.textContent = String(nextAttempt);
        if (hintEl) {
          hintEl.textContent = nextAttempt <= 3
            ? effHints[Math.min(nextAttempt, 3)]
            : 'No efficiency bonus remaining';
        }

        resultEl.innerHTML = `<span class="result-wrong">âŒ Incorrect. Try again.</span>`;
        submitBtn.textContent = 'Submit Answer';
        submitBtn.disabled = false;
      }
    } catch {
      resultEl.textContent = 'Submission failed. Try again.';
      submitBtn.textContent = 'Submit Answer';
      submitBtn.disabled = false;
    }
  });

  // â”€â”€ Copy input button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('copy-input-btn')?.addEventListener('click', async () => {
    const text = document.getElementById('input-data-text')?.textContent ?? '';
    try {
      await navigator.clipboard.writeText(text);
      const btn = document.getElementById('copy-input-btn')!;
      btn.textContent = 'Copied!';
      setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
    } catch {
      // clipboard not available
    }
  });

  // â”€â”€ Guest practice submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('guest-submit-btn')?.addEventListener('click', async () => {
    const answerEl = document.getElementById('challenge-answer-guest') as HTMLInputElement | null;
    const toolEl = document.getElementById('ai_tool_guest') as HTMLSelectElement | null;
    const resultEl = document.getElementById('guest-result')!;

    const answer = answerEl?.value.trim() ?? '';
    if (!answer) { resultEl.textContent = 'Please enter your answer.'; return; }

    const guestBtn = document.getElementById('guest-submit-btn') as HTMLButtonElement;
    guestBtn.textContent = 'Checking...';
    guestBtn.disabled = true;

    try {
      const res = await fetch('/api/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          puzzle_id: puzzleId,
          answer,
          agent_name: 'guest-practice',
          ai_tool: toolEl?.value || null,
          is_human: false,
        }),
      });
      const result = await res.json();
      if (result.correct) {
        resultEl.innerHTML = `<span class="result-correct">âœ… Correct! <a href="/api/auth/signin">Sign in</a> to record your score.</span>`;
      } else {
        resultEl.innerHTML = `<span class="result-wrong">âŒ Not quite. Try again.</span>`;
        guestBtn.textContent = 'Try Answer (Practice)';
        guestBtn.disabled = false;
      }
    } catch {
      resultEl.textContent = 'Check failed. Try again.';
      guestBtn.textContent = 'Try Answer (Practice)';
      guestBtn.disabled = false;
    }
  });
</script>

<style>
  .challenge-page {
    padding: 2.5rem 0 5rem;
  }

  /* â”€â”€ Breadcrumb â”€â”€ */
  .breadcrumb {
    margin-bottom: 2rem;
  }

  .breadcrumb-link {
    font-size: 0.9375rem;
    color: var(--dim);
    text-decoration: none;
    transition: color 0.15s;
  }
  .breadcrumb-link:hover { color: var(--text); }

  /* â”€â”€ Two-column grid â”€â”€ */
  .challenge-grid {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 2rem;
    align-items: start;
  }

  /* â”€â”€ Left column â”€â”€ */
  .challenge-main {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    min-width: 0;
  }

  /* â”€â”€ Header â”€â”€ */
  .challenge-header {
    padding-bottom: 0;
  }

  .puzzle-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
  }

  .badge-category {
    display: inline-flex;
    align-items: center;
    background: var(--surface-2, #f1f5f9);
    color: var(--dim);
    border: 1px solid var(--border);
    border-radius: 99px;
    padding: 0.15em 0.65em;
    font-size: 0.75rem;
    font-weight: 500;
    letter-spacing: 0.01em;
  }

  .puzzle-date {
    font-size: 0.875rem;
    color: var(--dim);
  }

  .puzzle-title {
    font-size: 2rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    color: var(--text);
  }

  /* â”€â”€ Section heading â”€â”€ */
  .section-heading {
    font-size: 0.9375rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 1rem;
    padding-bottom: 0.625rem;
    border-bottom: 1px solid var(--border);
  }

  /* â”€â”€ Input card â”€â”€ */
  .input-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    padding-bottom: 0.625rem;
    border-bottom: 1px solid var(--border);
  }

  .input-header h2 {
    margin-bottom: 0;
    border-bottom: none;
    padding-bottom: 0;
  }

  .btn-sm { font-size: 0.8125rem; padding: 0.375rem 0.75rem; }

  .input-note {
    font-size: 0.9375rem;
    color: var(--dim);
    margin-bottom: 0.5rem;
  }

  .input-data-pre {
    max-height: 320px;
    overflow-x: auto;
    overflow-y: auto;
  }

  /* â”€â”€ Solve card â”€â”€ */
  .challenge-solve {
    border: 1px solid #3b82f620;
    background: #3b82f606;
  }

  .section-sub {
    font-size: 0.9rem;
    color: var(--dim);
    margin-top: -0.5rem;
    margin-bottom: 1.25rem;
  }

  .scoring-summary {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
  }

  /* â”€â”€ Timer â”€â”€ */
  .timer-display {
    font-size: 3rem;
    font-weight: 800;
    font-variant-numeric: tabular-nums;
    letter-spacing: -0.02em;
    color: var(--accent);
    margin: 1rem 0 0.25rem;
  }

  .timer-sub {
    font-size: 0.875rem;
    color: var(--dim);
    margin-bottom: 1.5rem;
  }

  /* â”€â”€ Form â”€â”€ */
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    margin-bottom: 1rem;
  }

  .form-select {
    appearance: none;
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    padding-right: 2.25rem;
  }

  .submit-result {
    margin-top: 0.75rem;
    font-size: 0.9375rem;
  }

  .result-wrong { color: #ef4444; }
  .result-correct { color: #16a34a; }

  /* â”€â”€ Solve success â”€â”€ */
  .solve-success {
    text-align: center;
    padding: 1.5rem 1rem;
  }

  .success-badge {
    font-size: 1.25rem;
    font-weight: 700;
    color: #16a34a;
    margin-bottom: 0.75rem;
  }

  .solved-with {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text);
  }

  .score-breakdown {
    display: flex;
    gap: 0.25rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  /* â”€â”€ Score pills â”€â”€ */
  .score-pill-sm {
    display: inline-block;
    padding: 0.25rem 0.625rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 99px;
    font-size: 0.8125rem;
    margin: 0.125rem;
  }

  /* â”€â”€ Callout â”€â”€ */
  .callout {
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    margin-bottom: 1rem;
    border: 1px solid transparent;
  }

  .callout a {
    font-weight: 600;
    text-decoration: underline;
  }

  .callout-muted {
    background: var(--surface-2, #1e1e1e);
    border-color: var(--border);
    color: var(--dim);
  }

  .callout-muted a { color: var(--text); }

  /* â”€â”€ Sidebar â”€â”€ */
  .challenge-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    position: sticky;
    top: calc(var(--nav-height, 64px) + 1.5rem);
  }

  .sidebar-card { padding: 1.25rem; }

  .sidebar-heading {
    font-size: 0.9375rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 0.25rem;
  }

  .sidebar-sub {
    font-size: 0.8125rem;
    color: var(--dim);
    margin-bottom: 1rem;
  }

  .sidebar-more {
    display: block;
    text-align: center;
    margin-top: 1rem;
    font-size: 0.875rem;
    color: var(--accent);
    text-decoration: none;
    transition: opacity 0.15s;
  }
  .sidebar-more:hover { opacity: 0.8; }

  /* â”€â”€ Human entries leaderboard â”€â”€ */
  .empty-leaderboard {
    text-align: center;
    padding: 1.25rem 0;
    color: var(--dim);
    font-size: 0.875rem;
  }

  .empty-trophy {
    font-size: 2rem;
    display: block;
    margin-bottom: 0.5rem;
  }

  .human-entries {
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
    margin-bottom: 0.25rem;
  }

  .human-entry {
    display: grid;
    grid-template-columns: 1.75rem 1fr auto auto;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.8125rem;
  }

  .entry-rank {
    font-size: 0.9375rem;
    text-align: center;
  }

  .entry-login {
    color: var(--accent);
    text-decoration: none;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .entry-login:hover { text-decoration: underline; }

  .entry-tool {
    font-size: 0.75rem;
    color: var(--dim);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 60px;
  }

  .entry-time {
    font-size: 0.75rem;
    color: var(--dim);
    white-space: nowrap;
    font-variant-numeric: tabular-nums;
  }

  /* â”€â”€ Scoring list â”€â”€ */
  .scoring-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }

  .scoring-list li {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--dim);
  }

  .score-max {
    margin-left: auto;
    color: var(--text);
    font-weight: 600;
    font-size: 0.8125rem;
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .dot-green  { background: var(--success, #16a34a); }
  .dot-blue   { background: var(--accent); }
  .dot-yellow { background: #f59e0b; }

  /* â”€â”€ Tips list â”€â”€ */
  .tips-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding: 0;
  }

  .tips-list li {
    font-size: 0.875rem;
    color: var(--dim);
    line-height: 1.55;
    padding-left: 1rem;
    position: relative;
  }

  .tips-list li::before {
    content: 'â†’';
    position: absolute;
    left: 0;
    color: var(--accent);
    font-weight: 600;
  }

  /* â”€â”€ Responsive â”€â”€ */
  @media (max-width: 900px) {
    .challenge-grid {
      grid-template-columns: 1fr;
    }

    .challenge-sidebar {
      position: static;
    }
  }

  @media (max-width: 600px) {
    .puzzle-title { font-size: 1.5rem; }
    .timer-display { font-size: 2.25rem; }
  }
</style>
