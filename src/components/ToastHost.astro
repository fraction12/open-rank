<div class="toast-region" aria-live="polite" aria-atomic="false" data-toast-region></div>

<script>
  import { TOAST_EVENT } from '../lib/toast';
  import type { ToastDetail, ToastType } from '../lib/toast';

  const region = document.querySelector('[data-toast-region]') as HTMLElement | null;

  if (region) {
    const active = new Map<string, { el: HTMLElement; timer: ReturnType<typeof setTimeout> | null }>();

    function toastRole(type: ToastType): 'alert' | 'status' {
      return type === 'error' || type === 'warning' ? 'alert' : 'status';
    }

    function dismissToast(id: string): void {
      const item = active.get(id);
      if (!item) return;

      if (item.timer) clearTimeout(item.timer);
      item.el.classList.add('toast-exit');
      setTimeout(() => {
        item.el.remove();
      }, 180);

      active.delete(id);
    }

    function dismissLatestToast(): void {
      const ids = Array.from(active.keys());
      const latestId = ids[ids.length - 1];
      if (latestId) dismissToast(latestId);
    }

    function trimQueue(max = 5): void {
      if (active.size <= max) return;
      const oldestId = active.keys().next().value;
      if (oldestId) dismissToast(oldestId);
    }

    function toastIcon(type: ToastType): string {
      if (type === 'error') return '!';
      if (type === 'warning') return '!';
      if (type === 'success') return '✓';
      return 'i';
    }

    function pushToast(detail: ToastDetail): void {
      const toast = document.createElement('article');
      toast.className = `toast toast-${detail.type}`;
      toast.setAttribute('role', toastRole(detail.type));
      toast.setAttribute('aria-live', detail.type === 'error' ? 'assertive' : 'polite');

      const icon = document.createElement('span');
      icon.className = `toast-icon toast-icon-${detail.type}`;
      icon.setAttribute('aria-hidden', 'true');
      icon.textContent = toastIcon(detail.type);

      const body = document.createElement('div');
      body.className = 'toast-body';

      const title = document.createElement('p');
      title.className = 'toast-title';
      title.textContent = detail.title;

      const msg = document.createElement('p');
      msg.className = 'toast-message';
      msg.textContent = detail.message;

      body.appendChild(title);
      body.appendChild(msg);
      toast.appendChild(icon);
      toast.appendChild(body);

      if (detail.dismissible) {
        const close = document.createElement('button');
        close.className = 'toast-close';
        close.type = 'button';
        close.setAttribute('aria-label', 'Dismiss notification');
        close.textContent = '×';
        close.addEventListener('click', () => dismissToast(detail.id));
        toast.appendChild(close);
      }

      region.appendChild(toast);
      trimQueue();

      const timer = detail.durationMs > 0 ? setTimeout(() => dismissToast(detail.id), detail.durationMs) : null;
      active.set(detail.id, { el: toast, timer });
    }

    window.addEventListener(TOAST_EVENT, (event) => {
      const customEvent = event as CustomEvent<ToastDetail>;
      if (!customEvent.detail) return;
      pushToast(customEvent.detail);
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') dismissLatestToast();
    });
  }
</script>

<style>
  .toast-region {
    position: fixed;
    top: calc(var(--nav-height) + 0.75rem);
    right: 1rem;
    z-index: 250;
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
    width: min(380px, calc(100vw - 2rem));
    pointer-events: none;
  }

  .toast {
    pointer-events: auto;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: var(--bg);
    box-shadow: var(--shadow-md);
    padding: 0.8125rem 0.875rem;
    animation: toast-enter 0.2s ease-out;
  }

  .toast-exit {
    opacity: 0;
    transform: translateY(-6px);
    transition: opacity 0.18s ease-out, transform 0.18s ease-out;
  }

  @keyframes toast-enter {
    from {
      opacity: 0;
      transform: translateY(-8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .toast-icon {
    width: 1.4rem;
    height: 1.4rem;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.78rem;
    font-weight: 700;
    line-height: 1;
    flex-shrink: 0;
    margin-top: 0.05rem;
  }

  .toast-body {
    min-width: 0;
    flex: 1;
  }

  .toast-title {
    font-size: 0.8625rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 0.2rem;
    line-height: 1.3;
  }

  .toast-message {
    font-size: 0.8325rem;
    color: var(--dim);
    line-height: 1.4;
  }

  .toast-close {
    border: 1px solid transparent;
    background: transparent;
    color: var(--dim);
    font-size: 1.05rem;
    line-height: 1;
    padding: 0.15rem;
    border-radius: var(--radius-sm);
    cursor: pointer;
    margin-left: 0.15rem;
    transition: background-color 0.15s ease, color 0.15s ease, border-color 0.15s ease;
  }

  .toast-close:hover {
    background: var(--surface);
    color: var(--text);
    border-color: var(--border);
  }

  .toast-error {
    border-color: var(--error-subtle-border);
    background: var(--error-subtle);
  }
  .toast-icon-error {
    background: #fee2e2;
    color: #b91c1c;
  }

  .toast-warning {
    border-color: var(--warning-subtle-border);
    background: var(--warning-subtle);
  }
  .toast-icon-warning {
    background: #fef3c7;
    color: #92400e;
  }

  .toast-info {
    border-color: var(--accent-subtle-border);
    background: var(--accent-subtle);
  }
  .toast-icon-info {
    background: #dbeafe;
    color: #1d4ed8;
  }

  .toast-success {
    border-color: var(--success-subtle-border);
    background: var(--success-subtle);
  }
  .toast-icon-success {
    background: #dcfce7;
    color: #166534;
  }

  @media (max-width: 768px) {
    .toast-region {
      left: 1rem;
      right: 1rem;
      top: calc(var(--nav-height) + 0.6rem);
      width: auto;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .toast,
    .toast-exit {
      animation: none;
      transition: none;
    }
  }
</style>
