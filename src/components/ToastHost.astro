<div id="toast-region" aria-live="polite" aria-atomic="false"></div>

<script>
  import { TOAST_EVENT } from '../lib/toast';
  import type { ToastDetail, ToastType } from '../lib/toast';

  const region = document.getElementById('toast-region') as HTMLElement | null;
  if (!region) throw new Error('toast-region not found');

  const active = new Map<string, { el: HTMLElement; timer: ReturnType<typeof setTimeout> | null }>();

  function dismiss(id: string) {
    const item = active.get(id);
    if (!item) return;
    if (item.timer) clearTimeout(item.timer);
    item.el.style.opacity = '0';
    item.el.style.transform = 'translateY(6px)';
    setTimeout(() => item.el.remove(), 200);
    active.delete(id);
  }

  function push(detail: ToastDetail) {
    if (active.size >= 4) {
      const oldest = active.keys().next().value;
      if (oldest) dismiss(oldest);
    }

    const el = document.createElement('div');
    el.className = `toast toast-${detail.type}`;
    el.setAttribute('role', detail.type === 'error' || detail.type === 'warning' ? 'alert' : 'status');

    const bar = document.createElement('span');
    bar.className = 'toast-bar';
    el.appendChild(bar);

    const body = document.createElement('div');
    body.className = 'toast-body';

    const title = document.createElement('p');
    title.className = 'toast-title';
    title.textContent = detail.title;
    body.appendChild(title);

    if (detail.message) {
      const msg = document.createElement('p');
      msg.className = 'toast-msg';
      msg.textContent = detail.message;
      body.appendChild(msg);
    }

    el.appendChild(body);

    if (detail.dismissible) {
      const btn = document.createElement('button');
      btn.className = 'toast-x';
      btn.setAttribute('aria-label', 'Dismiss');
      btn.textContent = 'Ã—';
      btn.onclick = () => dismiss(detail.id);
      el.appendChild(btn);
    }

    region.appendChild(el);
    void el.offsetHeight; // force reflow before animating in
    el.style.opacity = '1';
    el.style.transform = 'translateY(0)';

    const timer = detail.durationMs > 0 ? setTimeout(() => dismiss(detail.id), detail.durationMs) : null;
    active.set(detail.id, { el, timer });
  }

  window.addEventListener(TOAST_EVENT, (e) => {
    const detail = (e as CustomEvent<ToastDetail>).detail;
    if (detail) push(detail);
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const last = Array.from(active.keys()).pop();
      if (last) dismiss(last);
    }
  });
</script>

<style>
  #toast-region {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    width: min(360px, calc(100vw - 2rem));
    pointer-events: none;
  }

  .toast {
    pointer-events: auto;
    display: flex;
    align-items: stretch;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: var(--bg);
    box-shadow: var(--shadow-md);
    overflow: hidden;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.18s ease, transform 0.18s ease;
  }

  .toast-bar {
    width: 3px;
    flex-shrink: 0;
  }

  .toast-body {
    flex: 1;
    padding: 0.75rem 0.875rem;
    min-width: 0;
  }

  .toast-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text);
    line-height: 1.3;
  }

  .toast-msg {
    font-size: 0.8125rem;
    color: var(--dim);
    margin-top: 0.2rem;
    line-height: 1.4;
  }

  .toast-x {
    background: transparent;
    border: none;
    color: var(--dim);
    font-size: 1.1rem;
    line-height: 1;
    padding: 0 0.75rem;
    cursor: pointer;
    flex-shrink: 0;
    transition: color 0.15s;
  }
  .toast-x:hover { color: var(--text); }

  .toast-success .toast-bar { background: var(--success); }
  .toast-success { border-color: var(--success-subtle-border); }

  .toast-error .toast-bar { background: var(--error); }
  .toast-error { border-color: var(--error-subtle-border); }

  .toast-warning .toast-bar { background: var(--warning); }
  .toast-warning { border-color: var(--warning-subtle-border); }

  .toast-info .toast-bar { background: var(--accent); }
  .toast-info { border-color: var(--accent-subtle-border); }

  @media (max-width: 600px) {
    #toast-region {
      bottom: 1rem;
      right: 1rem;
      left: 1rem;
      width: auto;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .toast { transition: none; }
  }
</style>
