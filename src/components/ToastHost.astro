<div id="toast-region" aria-live="polite" aria-atomic="false"></div>

<script>
  import { TOAST_EVENT } from '../lib/toast';
  import type { ToastDetail } from '../lib/toast';

  const region = document.getElementById('toast-region') as HTMLElement | null;
  if (!region) throw new Error('toast-region not found');

  const active = new Map<string, { el: HTMLElement; timer: ReturnType<typeof setTimeout> | null }>();

  function dismiss(id: string) {
    const item = active.get(id);
    if (!item) return;
    if (item.timer) clearTimeout(item.timer);
    item.el.style.opacity = '0';
    item.el.style.transform = 'translateY(6px)';
    setTimeout(() => item.el.remove(), 200);
    active.delete(id);
  }

  function push(detail: ToastDetail) {
    if (active.size >= 4) {
      const oldest = active.keys().next().value;
      if (oldest) dismiss(oldest);
    }

    const el = document.createElement('div');
    el.className = `toast toast-${detail.type}`;
    el.setAttribute('role', detail.type === 'error' || detail.type === 'warning' ? 'alert' : 'status');

    const bar = document.createElement('span');
    bar.className = 'toast-bar';
    el.appendChild(bar);

    const body = document.createElement('div');
    body.className = 'toast-body';

    const title = document.createElement('p');
    title.className = 'toast-title';
    title.textContent = detail.title;
    body.appendChild(title);

    if (detail.message) {
      const msg = document.createElement('p');
      msg.className = 'toast-msg';
      msg.textContent = detail.message;
      body.appendChild(msg);
    }

    el.appendChild(body);

    if (detail.dismissible) {
      const btn = document.createElement('button');
      btn.className = 'toast-x';
      btn.setAttribute('aria-label', 'Dismiss');
      btn.textContent = 'Ã—';
      btn.onclick = () => dismiss(detail.id);
      el.appendChild(btn);
    }

    region.appendChild(el);
    void el.offsetHeight; // force reflow before animating in
    el.style.opacity = '1';
    el.style.transform = 'translateY(0)';

    const timer = detail.durationMs > 0 ? setTimeout(() => dismiss(detail.id), detail.durationMs) : null;
    active.set(detail.id, { el, timer });
  }

  window.addEventListener(TOAST_EVENT, (e) => {
    const detail = (e as CustomEvent<ToastDetail>).detail;
    if (detail) push(detail);
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const last = Array.from(active.keys()).pop();
      if (last) dismiss(last);
    }
  });
</script>
