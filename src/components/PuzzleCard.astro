---
import Badge from './Badge.astro';

type PuzzleCategory = 'data_analysis' | 'coding' | 'cipher_reasoning' | 'multi_step' | 'code_review' | 'long_context' | 'web_research' | 'agentic_engineering' | null;

interface Props {
  id: string;
  title: string;
  difficulty: 'easy' | 'medium' | 'hard' | 'insane';
  category?: PuzzleCategory;
  description: string;
  releaseDate?: string;
  completionRate?: number;
  topAgent?: string;
  practiceCount?: number;
  showStats?: boolean;
  /** Base path for the card link. Defaults to '/puzzle'. Use '/challenges' for challenge cards. */
  linkBase?: string;
}

const {
  id,
  title,
  difficulty,
  category,
  description,
  releaseDate,
  completionRate,
  topAgent,
  practiceCount,
  showStats = false,
  linkBase = '/puzzle',
} = Astro.props;

const categoryMeta: Record<NonNullable<PuzzleCategory>, { emoji: string; label: string }> = {
  data_analysis:    { emoji: 'üìä', label: 'Data Analysis' },
  coding:           { emoji: 'üíª', label: 'Coding' },
  cipher_reasoning: { emoji: 'üîê', label: 'Cipher' },
  multi_step:       { emoji: 'üß©', label: 'Multi-step' },
  code_review:         { emoji: 'üìÅ', label: 'Code Review' },
  long_context:        { emoji: 'üß†', label: 'Long Context' },
  web_research:        { emoji: 'üîç', label: 'Web Research' },
  agentic_engineering: { emoji: 'üõ†Ô∏è', label: 'Agentic Eng' },
};

const catInfo = category ? categoryMeta[category] : null;
const preview = description.length > 150 ? description.slice(0, 147) + '...' : description;
const href = `${linkBase}/${id}`;
---

<a href={href} class="puzzle-card card">
  <div class="puzzle-card-header">
    <div class="puzzle-card-badges">
      <Badge variant={difficulty} label={difficulty.toUpperCase()} />
      {catInfo && (
        <Badge variant="category" label={`${catInfo.emoji} ${catInfo.label}`} />
      )}
    </div>
    {releaseDate && (
      <time class="puzzle-date" datetime={releaseDate}>
        {new Date(releaseDate).toLocaleDateString('en-US', {
          month: 'short', day: 'numeric', year: 'numeric', timeZone: 'UTC',
        })}
      </time>
    )}
  </div>

  <h3 class="puzzle-title">{title}</h3>

  <p class="puzzle-preview">{preview}</p>

  {showStats && (
    <div class="puzzle-stats">
      {completionRate != null && (
        <span class="puzzle-stat stat-solved">
          <span>‚úì</span>
          {completionRate.toFixed(0)}% solved
        </span>
      )}
      <span class:list={['puzzle-stat', topAgent ? 'stat-top' : 'stat-empty']}>
        <span>üèÜ</span>
        {topAgent ?? '‚Äî'}
      </span>
      <span class:list={['puzzle-stat', (practiceCount ?? 0) > 0 ? 'stat-practice' : 'stat-empty']}>
        <span>üî¨</span>
        {(practiceCount ?? 0) > 0 ? `${practiceCount} Practice` : '‚Äî'}
      </span>
    </div>
  )}
</a>

<style>
  .puzzle-card {
    display: flex;
    flex-direction: column;
    gap: 0.875rem;
    text-decoration: none;
    color: inherit;
    cursor: pointer;
    transition: box-shadow 0.15s ease, border-color 0.15s ease, transform 0.15s ease;
  }

  .puzzle-card:hover {
    border-color: var(--accent-subtle-border);
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
  }

  .puzzle-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
  }

  .puzzle-card-badges {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    flex-wrap: wrap;
  }

  .puzzle-date {
    font-size: 0.8125rem;
    color: var(--dim);
  }

  .puzzle-title {
    font-size: 1.1875rem;
    font-weight: 600;
    line-height: 1.3;
    color: var(--text);
  }

  .puzzle-card:hover .puzzle-title {
    color: var(--accent);
  }

  .puzzle-preview {
    font-size: 0.9375rem;
    color: var(--dim);
    line-height: 1.65;
    flex: 1;
  }

  .puzzle-stats {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    padding-top: 0.25rem;
    border-top: 1px solid var(--border);
  }

  .puzzle-stat {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.8125rem;
    font-weight: 500;
    padding: 0.2em 0.6em;
    border-radius: 99px;
  }

  .stat-solved {
    background: var(--success-subtle);
    color: var(--success);
    border: 1px solid var(--success-subtle-border);
  }

  .stat-top {
    background: var(--accent-subtle);
    color: var(--accent);
    border: 1px solid var(--accent-subtle-border);
  }

  .stat-practice {
    background: var(--surface);
    color: var(--dim);
    border: 1px solid var(--border);
  }

  .stat-empty {
    background: var(--surface);
    color: var(--dim);
    border: 1px solid var(--border);
    opacity: 0.6;
  }
</style>
